<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Homescape Pet & Match-3</title>
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <!-- Telegram WebApp JS -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root {
      --bg-main: #f9f4f0;
      --bg-card: #ffffff;
      --bg-soft: #ffe9d6;
      --accent: #ff9f6b;
      --accent-strong: #ff7b7b;
      --accent-soft: rgba(255, 159, 107, 0.18);
      --text-main: #2f3542;
      --text-soft: #6b7280;
      --radius-xl: 24px;
      --radius-lg: 18px;
      --shadow-soft: 0 16px 36px rgba(15, 23, 42, 0.24);
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #ffe7cf 0, #f9f4f0 40%, #f1e3dd 100%);
      color: var(--text-main);
    }

    body {
      display: flex;
      justify-content: center;
      align-items: stretch;
    }

    .app {
      position: relative;
      width: 100%;
      max-width: 520px;
      height: 100vh;
      height: 100dvh;
      padding: calc(10px + env(safe-area-inset-top, 10px))
               12px
               calc(12px + env(safe-area-inset-bottom, 16px));
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    /* HEADER */
    .app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.85);
      box-shadow: 0 10px 24px rgba(15, 23, 42, 0.14);
      backdrop-filter: blur(14px);
      z-index: 3;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 0;
    }

    .close-btn {
      width: 30px;
      height: 30px;
      border-radius: 999px;
      border: none;
      outline: none;
      cursor: pointer;
      background: rgba(148, 163, 184, 0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 15px;
    }

    .user-chip {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.95);
    }

    .user-avatar {
      width: 20px;
      height: 20px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      background: linear-gradient(135deg, #ff9f6b, #ff6f91);
      color: #fff;
    }

    .user-name {
      max-width: 110px;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-soft);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .header-right {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 999px;
      background: linear-gradient(135deg, #ffd28f, #ff9f6b);
      color: #fff;
      font-size: 12px;
      font-weight: 700;
    }

    /* SCREENS */
    .screens {
      position: relative;
      flex: 1;
      min-height: 0;
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-soft);
      background: linear-gradient(145deg, #fffaf4, #ffffff);
      overflow: hidden;
    }

    .screen {
      position: absolute;
      inset: 0;
      display: none;
      overflow-y: auto;
      padding: 10px 10px 12px;
    }

    .screen.active {
      display: block;
    }

    .screen-inner {
      min-height: 100%;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .card {
      border-radius: var(--radius-xl);
      background: linear-gradient(145deg, #fffaf4, #ffffff);
      padding: 14px 12px 10px;
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: -40%;
      background-image:
        radial-gradient(circle at 0 0, rgba(255, 180, 117, 0.2) 0, transparent 55%),
        radial-gradient(circle at 100% 0, rgba(126, 196, 255, 0.18) 0, transparent 60%),
        radial-gradient(circle at 0 100%, rgba(135, 255, 167, 0.16) 0, transparent 45%),
        radial-gradient(circle at 100% 100%, rgba(255, 171, 193, 0.16) 0, transparent 50%);
      opacity: 0.9;
      pointer-events: none;
    }

    .card-content {
      position: relative;
      z-index: 1;
    }

    .card-title-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 4px;
    }

    .card-title {
      font-size: 18px;
      font-weight: 700;
      color: #374151;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card-subtitle {
      font-size: 13px;
      color: var(--text-soft);
    }

    .footer-sticky {
      margin-top: auto;
      position: sticky;
      bottom: 0;
      padding-top: 6px;
      background: linear-gradient(to top,
        rgba(249, 244, 240, 0.95),
        rgba(249, 244, 240, 0.7),
        transparent);
    }

    .btn-primary {
      width: 100%;
      border-radius: 999px;
      border: none;
      outline: none;
      cursor: pointer;
      padding: 14px 16px;
      font-size: 15px;
      font-weight: 700;
      background: linear-gradient(135deg, #ff9f6b, #ff7b7b);
      color: #fff;
      box-shadow: 0 14px 30px rgba(254, 140, 101, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .btn-primary:active {
      transform: translateY(1px) scale(0.99);
      box-shadow: 0 8px 18px rgba(254, 140, 101, 0.4);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      box-shadow: none;
      cursor: default;
    }

    .btn-secondary {
      border-radius: 999px;
      border: none;
      outline: none;
      cursor: pointer;
      padding: 8px 12px;
      font-size: 13px;
      font-weight: 600;
      background: rgba(255, 255, 255, 0.95);
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.15);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      color: #374151;
    }

    .btn-secondary:active {
      transform: translateY(1px);
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.2);
    }

    /* PET SELECT */
    .pet-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
      margin-top: 8px;
    }

    .pet-card {
      border-radius: 20px;
      padding: 8px 6px;
      background: linear-gradient(145deg, #ffffff, #ffe6c8);
      box-shadow: 0 8px 18px rgba(0, 0, 0, 0.12);
      border: 2px solid transparent;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      transition: transform 0.12s ease, box-shadow 0.12s ease, border 0.12s ease;
    }

    .pet-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 24px rgba(255, 159, 107, 0.32);
    }

    .pet-card.selected {
      border-color: var(--accent-strong);
      box-shadow: 0 14px 28px rgba(255, 159, 107, 0.45);
    }

    .pet-sprite {
      width: 70px;
      height: 70px;
      border-radius: 24px;
      background: radial-gradient(circle at 30% 10%, #ffffff 0, #ffe0c4 50%, #ffb37f 100%);
      box-shadow: inset 0 0 0 2px rgba(255, 255, 255, 0.7),
                  0 8px 16px rgba(0, 0, 0, 0.18);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      position: relative;
    }

    .pet-sprite::after {
      content: "";
      position: absolute;
      top: -40%;
      left: -20%;
      width: 140%;
      height: 60%;
      background: linear-gradient(to bottom, rgba(255, 255, 255, 1), transparent);
      opacity: 0.9;
    }

    .pet-emoji {
      font-size: 40px;
      position: relative;
      z-index: 1;
      animation: float-pet 2.3s ease-in-out infinite;
    }

    .pet-name-label {
      font-size: 13px;
      font-weight: 700;
      color: #374151;
    }

    .pet-tag {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.75);
      color: var(--text-soft);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .form-group {
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .form-label {
      font-size: 13px;
      font-weight: 600;
      color: #4b5563;
    }

    .form-input {
      border-radius: 999px;
      border: 1.5px solid rgba(148, 163, 184, 0.5);
      padding: 10px 14px;
      font-size: 14px;
      outline: none;
      background: rgba(255, 255, 255, 0.95);
      box-shadow: 0 6px 14px rgba(15, 23, 42, 0.08);
    }

    .form-input:focus {
      border-color: #ff9f6b;
      box-shadow: 0 0 0 1px rgba(255, 159, 107, 0.5);
    }

    /* PET MAIN */
    .pet-header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 4px;
    }

    .pet-name-chip {
      flex: 1;
      text-align: center;
      font-size: 16px;
      font-weight: 700;
      color: #374151;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.9);
      box-shadow: 0 6px 12px rgba(15, 23, 42, 0.12);
    }

    .coin-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.95);
      box-shadow: 0 6px 12px rgba(15, 23, 42, 0.12);
      font-size: 13px;
      font-weight: 600;
    }

    .coin-chip span:first-child {
      font-size: 16px;
    }

    .pet-stage-wrap {
      margin-top: 6px;
      display: flex;
      justify-content: center;
    }

    .pet-stage {
      width: 230px;
      max-width: 100%;
      aspect-ratio: 1 / 1;
      border-radius: 32px;
      background: radial-gradient(circle at 50% 10%, #fffdf9 0, #ffe0c5 50%, #ffb37f 100%);
      box-shadow: 0 16px 40px rgba(15, 23, 42, 0.35);
      position: relative;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .pet-floor {
      position: absolute;
      inset-inline: -20%;
      bottom: -6%;
      height: 40%;
      background:
        radial-gradient(circle at 20% 0, rgba(255, 255, 255, 0.8) 0, transparent 60%),
        radial-gradient(circle at 80% 0, rgba(255, 255, 255, 0.9) 0, transparent 60%),
        radial-gradient(circle at 50% 30%, rgba(0, 0, 0, 0.18) 0, transparent 70%);
      opacity: 0.8;
    }

    .pet-main-sprite {
      width: 130px;
      height: 130px;
      border-radius: 40px;
      background: radial-gradient(circle at 30% 10%, #ffffff 0, #ffe3c9 50%, #ffb47f 100%);
      box-shadow: inset 0 0 0 2px rgba(255, 255, 255, 0.9),
                  0 16px 32px rgba(15, 23, 42, 0.35);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }

    .pet-main-emoji {
      font-size: 64px;
      position: relative;
      z-index: 2;
      animation: idle-breathe 2.5s ease-in-out infinite;
    }

    .pet-main-highlight {
      position: absolute;
      top: -40%;
      left: -10%;
      width: 130%;
      height: 60%;
      background: linear-gradient(to bottom, rgba(255, 255, 255, 1), transparent);
      opacity: 0.9;
      z-index: 1;
    }

    .pet-heart {
      position: absolute;
      font-size: 26px;
      animation: heart-pop 0.8s ease-out forwards;
      pointer-events: none;
      left: 50%;
      bottom: 24%;
      transform: translateX(-50%);
    }

    .pet-bounce {
      animation: pet-bounce 0.4s ease-out;
    }

    .mood-label {
      margin-top: 4px;
      font-size: 12px;
      text-align: center;
      color: var(--text-soft);
    }

    /* STATS */
    .stats {
      margin-top: 8px;
      border-radius: var(--radius-lg);
      background: rgba(255, 255, 255, 0.95);
      padding: 8px 8px 6px;
      box-shadow: 0 10px 22px rgba(15, 23, 42, 0.12);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .stat-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .stat-icon {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.95);
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.16);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }

    .stat-content {
      flex: 1;
    }

    .stat-label-row {
      font-size: 11px;
      display: flex;
      justify-content: space-between;
      color: var(--text-soft);
    }

    .stat-label-row strong {
      color: #374151;
    }

    .stat-bar {
      margin-top: 2px;
      width: 100%;
      height: 10px;
      border-radius: 999px;
      background: rgba(229, 231, 235, 0.9);
      overflow: hidden;
      position: relative;
    }

    .stat-fill {
      position: absolute;
      inset-block: 0;
      left: 0;
      width: 50%;
      border-radius: inherit;
      background: linear-gradient(90deg, #ff9f6b, #ff7b7b);
      box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.7);
      transition: width 0.22s ease-out;
    }

    .stat-fill.mood {
      background: linear-gradient(90deg, #a5b4fc, #f97373);
    }

    /* PET BOTTOM PANEL */
    .pet-bottom {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .pet-bottom-row {
      display: flex;
      gap: 8px;
    }

    .pet-bottom-row .btn-secondary {
      flex: 1;
    }

    /* SHOP */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.3);
      display: none;
      justify-content: center;
      align-items: flex-end;
      padding: 0 12px calc(12px + env(safe-area-inset-bottom, 16px));
      z-index: 20;
    }

    .overlay.visible {
      display: flex;
    }

    .shop-panel {
      width: 100%;
      max-width: 520px;
      border-radius: 24px 24px 0 0;
      background: #fff7ee;
      box-shadow: 0 -16px 40px rgba(15, 23, 42, 0.5);
      padding: 10px 12px 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .shop-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .shop-title {
      font-size: 16px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .shop-tabs {
      display: flex;
      gap: 6px;
      margin-top: 4px;
    }

    .shop-tab {
      flex: 1;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 13px;
      font-weight: 600;
      border: none;
      outline: none;
      cursor: pointer;
      background: rgba(255, 255, 255, 0.9);
      color: #4b5563;
      box-shadow: 0 6px 12px rgba(15, 23, 42, 0.1);
    }

    .shop-tab.active {
      background: linear-gradient(135deg, #ff9f6b, #ff7b7b);
      color: #fff;
      box-shadow: 0 8px 18px rgba(254, 140, 101, 0.5);
    }

    .shop-items {
      margin-top: 4px;
      max-height: 45vh;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding-right: 2px;
    }

    .shop-item {
      border-radius: 18px;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.96), #ffe6c8);
      padding: 8px 8px 8px;
      display: flex;
      gap: 8px;
      align-items: center;
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.14);
    }

    .shop-icon {
      width: 40px;
      height: 40px;
      border-radius: 16px;
      background: radial-gradient(circle at 30% 10%, #ffffff 0, #ffd7aa 50%, #ffb779 100%);
      box-shadow: 0 8px 16px rgba(15, 23, 42, 0.25);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
    }

    .shop-body {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .shop-name {
      font-size: 14px;
      font-weight: 700;
      color: #374151;
    }

    .shop-desc {
      font-size: 11px;
      color: var(--text-soft);
    }

    .shop-meta {
      margin-top: 2px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      color: var(--text-soft);
    }

    .shop-price {
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.95);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .shop-effect {
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.8);
    }

    .shop-action {
      display: flex;
      flex-direction: column;
      align-items: stretch;
      gap: 4px;
    }

    .shop-btn {
      border-radius: 999px;
      border: none;
      outline: none;
      cursor: pointer;
      padding: 6px 10px;
      font-size: 12px;
      font-weight: 600;
      background: linear-gradient(135deg, #ff9f6b, #ff7b7b);
      color: #fff;
      box-shadow: 0 8px 18px rgba(254, 140, 101, 0.5);
    }

    .shop-btn:active {
      transform: translateY(1px);
      box-shadow: 0 4px 10px rgba(254, 140, 101, 0.4);
    }

    .shop-btn.disabled {
      opacity: 0.5;
      box-shadow: none;
      cursor: default;
      background: rgba(148, 163, 184, 0.45);
    }

    .shop-footer {
      margin-top: 6px;
      display: flex;
      justify-content: flex-end;
    }

    /* LEVEL SELECT */
    .level-grid {
      margin-top: 8px;
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
    }

    .level-card {
      border-radius: 16px;
      padding: 8px 6px;
      background: linear-gradient(145deg, #ffffff, #e6f4ff);
      box-shadow: 0 8px 16px rgba(15, 23, 42, 0.16);
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }

    .level-card.locked {
      opacity: 0.5;
      cursor: default;
    }

    .level-badge {
      width: 32px;
      height: 32px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.96);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      box-shadow: 0 6px 12px rgba(15, 23, 42, 0.14);
    }

    .level-name {
      font-size: 12px;
      font-weight: 600;
    }

    .level-meta {
      font-size: 11px;
      color: var(--text-soft);
      text-align: center;
    }

    /* MATCH-3 */
    .match-top-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
    }

    .match-info-chip {
      border-radius: 999px;
      padding: 4px 10px;
      background: rgba(255, 255, 255, 0.95);
      font-size: 11px;
      color: var(--text-soft);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 6px 12px rgba(15, 23, 42, 0.12);
    }

    .match-info-chip strong {
      color: #374151;
    }

    .match-board-wrap {
      margin-top: 4px;
      border-radius: 20px;
      padding: 8px 6px 10px;
      background: radial-gradient(circle at top, #fff, #f5e0ff);
      box-shadow: 0 10px 22px rgba(15, 23, 42, 0.18);
      display: flex;
      justify-content: center;
    }

    .match-board {
      display: grid;
      gap: 4px;
      justify-content: center;
      touch-action: manipulation;
    }

    .match-cell {
      width: 34px;
      height: 34px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.96);
      box-shadow: 0 4px 8px rgba(15, 23, 42, 0.16);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      cursor: pointer;
      transition: transform 0.12s ease, box-shadow 0.12s ease, background 0.12s ease, opacity 0.15s ease;
    }

    .match-cell.empty {
      opacity: 0;
      pointer-events: none;
      box-shadow: none;
    }

    .match-cell.selected {
      transform: translateY(-2px) scale(1.05);
      box-shadow: 0 8px 18px rgba(59, 130, 246, 0.6);
      background: rgba(239, 246, 255, 0.96);
    }

    .match-cell.remove {
      animation: cell-pop 0.3s ease-out forwards;
    }

    .match-message {
      margin-top: 6px;
      font-size: 12px;
      color: var(--text-soft);
      text-align: center;
    }

    .match-bottom {
      margin-top: 8px;
      display: flex;
      gap: 8px;
    }

    .match-bottom .btn-secondary {
      flex: 1;
    }

    /* TEXT UTIL */
    .text-soft { color: var(--text-soft); font-size: 12px; }
    .mt-xs { margin-top: 4px; }
    .mt-s { margin-top: 8px; }

    /* ANIMATIONS */
    @keyframes float-pet {
      0% { transform: translateY(0); }
      50% { transform: translateY(-3px); }
      100% { transform: translateY(0); }
    }

    @keyframes idle-breathe {
      0% { transform: translateY(0) scale(1); }
      40% { transform: translateY(-2px) scale(1.02); }
      80% { transform: translateY(0) scale(1); }
      100% { transform: translateY(0) scale(1); }
    }

    @keyframes pet-bounce {
      0% { transform: translateY(0) scale(1); }
      30% { transform: translateY(-12px) scale(1.06); }
      60% { transform: translateY(4px) scale(0.96); }
      100% { transform: translateY(0) scale(1); }
    }

    @keyframes heart-pop {
      0% { transform: translate(-50%, -10px) scale(0.6); opacity: 0; }
      20% { opacity: 1; }
      100% { transform: translate(-50%, -42px) scale(1.2); opacity: 0; }
    }

    @keyframes cell-pop {
      0%   { transform: scale(1); opacity: 1; }
      70%  { transform: scale(1.2); opacity: 0.4; }
      100% { transform: scale(0.3); opacity: 0; }
    }

    @media (max-height: 640px) {
      .pet-stage {
        width: 200px;
      }
      .pet-main-sprite {
        width: 115px;
        height: 115px;
      }
      .pet-main-emoji {
        font-size: 56px;
      }
      .match-cell {
        width: 30px;
        height: 30px;
        font-size: 20px;
      }
    }
  </style>
</head>
<body>
<div class="app">
  <!-- HEADER -->
  <header class="app-header">
    <div class="header-left">
      <button class="close-btn" id="btnClose">‚úï</button>
      <div class="user-chip">
        <div class="user-avatar" id="userAvatar">üß∏</div>
        <div class="user-name" id="userName">–ì–æ—Å—Ç—å</div>
      </div>
    </div>
    <div class="header-right">
      <span>üí∞</span>
      <span id="headerCoins">0</span>
    </div>
  </header>

  <!-- SCREENS -->
  <main class="screens">
    <!-- SCREEN: Select pet -->
    <section class="screen active" id="screen-pet-select">
      <div class="screen-inner">
        <div class="card">
          <div class="card-content">
            <div class="card-title-row">
              <div class="card-title">
                –í—ã–±–µ—Ä–∏ –ø–∏—Ç–æ–º—Ü–∞
                <span>üè°</span>
              </div>
            </div>
            <div class="card-subtitle">
              –ù–æ—Å–∏–∫, —Ö–≤–æ—Å—Ç –∏ –º–æ—Ä–µ —É—é—Ç–∞ ‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ —Å –∫–µ–º –±—É–¥–µ—Ç–µ –∂–∏—Ç—å –≤ –¥–æ–º–∏–∫–µ.
            </div>

            <div class="pet-grid">
              <button class="pet-card" data-pet="cat" type="button">
                <div class="pet-sprite">
                  <div class="pet-emoji">üê±</div>
                </div>
                <div class="pet-name-label">–ö–æ—à–∫–∞</div>
                <div class="pet-tag">üß∂ –õ–∞—Å–∫–æ–≤–∞—è</div>
              </button>

              <button class="pet-card" data-pet="dog" type="button">
                <div class="pet-sprite">
                  <div class="pet-emoji">üê∂</div>
                </div>
                <div class="pet-name-label">–°–æ–±–∞–∫–∞</div>
                <div class="pet-tag">ü¶¥ –ò–≥—Ä–∏–≤—ã–π</div>
              </button>

              <button class="pet-card" data-pet="hamster" type="button">
                <div class="pet-sprite">
                  <div class="pet-emoji">üêπ</div>
                </div>
                <div class="pet-name-label">–•–æ–º—è–∫</div>
                <div class="pet-tag">üå∞ –ü—É—Ö–ª—ã–π</div>
              </button>
            </div>

            <p class="text-soft mt-xs">
              –ú–æ–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –ø–∏—Ç–æ–º—Ü—É –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç ‚Äî –ø—Ä–æ–≥—Ä–µ—Å—Å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ.
            </p>
          </div>
        </div>

        <div class="footer-sticky">
          <button class="btn-primary" id="btnPetSelectNext" disabled>
            –î–∞–ª–µ–µ <span>‚ûú</span>
          </button>
        </div>
      </div>
    </section>

    <!-- SCREEN: Pet name -->
    <section class="screen" id="screen-pet-name">
      <div class="screen-inner">
        <div class="card">
          <div class="card-content">
            <div class="card-title-row">
              <div class="card-title">
                –ò–º—è –ø–∏—Ç–æ–º—Ü–∞
                <span>‚úèÔ∏è</span>
              </div>
            </div>
            <div class="card-subtitle" id="petNameSubtitle">
              –ü—Ä–∏–¥—É–º–∞–π—Ç–µ —Ç—ë–ø–ª–æ–µ –∏–º—è –¥–ª—è –≤–∞—à–µ–≥–æ –Ω–æ–≤–æ–≥–æ –¥—Ä—É–≥–∞.
            </div>

            <div class="form-group">
              <label class="form-label" for="petNameInput">–ö–∞–∫ –Ω–∞–∑–æ–≤—ë–º –ø–∏—Ç–æ–º—Ü–∞?</label>
              <input id="petNameInput"
                     class="form-input"
                     type="text"
                     maxlength="18"
                     placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü—É—à–æ–∫, –õ–æ—Ä–∞, –ë—É–±–∞..." />
            </div>

            <p class="text-soft mt-xs">
              –ò–º—è –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ–∑–∂–µ, –Ω–æ –ø–∏—Ç–æ–º—Ü—É –ø–æ–Ω—Ä–∞–≤–∏—Ç—Å—è, –∫–æ–≥–¥–∞ –≤—ã –±—É–¥–µ—Ç–µ –∑–≤–∞—Ç—å –µ–≥–æ –ª–∞—Å–∫–æ–≤–æ. üíõ
            </p>
          </div>
        </div>

        <div class="footer-sticky">
          <button class="btn-primary" id="btnCreatePet">
            –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å <span>‚ú®</span>
          </button>
        </div>
      </div>
    </section>

    <!-- SCREEN: Pet main -->
    <section class="screen" id="screen-pet-main">
      <div class="screen-inner">
        <div class="card">
          <div class="card-content">
            <div class="pet-header-row">
              <div class="coin-chip">
                <span>üí∞</span>
                <span id="coinsChip">0</span>
              </div>
              <div class="pet-name-chip" id="petNameLabel">–ü–∏—Ç–æ–º–µ—Ü</div>
            </div>

            <div class="pet-stage-wrap">
              <div class="pet-stage" id="petStage">
                <div class="pet-floor"></div>
                <div class="pet-main-sprite" id="petSprite">
                  <div class="pet-main-highlight"></div>
                  <div class="pet-main-emoji" id="petEmoji">üê±</div>
                </div>
                <div class="pet-heart" id="petHeart" style="display:none;">üíõ</div>
              </div>
            </div>
            <div class="mood-label" id="moodLabel">
              –ü–∏—Ç–æ–º–µ—Ü —Å–ø–æ–∫–æ–µ–Ω –∏ –∂–¥—ë—Ç –∏–≥—Ä ‚ú®
            </div>

            <div class="stats">
              <div class="stat-row">
                <div class="stat-icon">üçó</div>
                <div class="stat-content">
                  <div class="stat-label-row">
                    <span>–°—ã—Ç–æ—Å—Ç—å</span>
                    <span><strong id="satietyText">100 / 100</strong></span>
                  </div>
                  <div class="stat-bar">
                    <div class="stat-fill" id="satietyBar"></div>
                  </div>
                </div>
              </div>

              <div class="stat-row">
                <div class="stat-icon">üòä</div>
                <div class="stat-content">
                  <div class="stat-label-row">
                    <span>–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ</span>
                    <span><strong id="moodText">100 / 100</strong></span>
                  </div>
                  <div class="stat-bar">
                    <div class="stat-fill mood" id="moodBar"></div>
                  </div>
                </div>
              </div>

              <p class="text-soft mt-xs">
                –°—ã—Ç–æ—Å—Ç—å –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø–∞–¥–∞—é—Ç —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º. –ö–æ—Ä–º–∏—Ç–µ –∏ –∏–≥—Ä–∞–π—Ç–µ, —á—Ç–æ–±—ã –ø–∏—Ç–æ–º–µ—Ü –±—ã–ª —Å—á–∞—Å—Ç–ª–∏–≤ üíõ
              </p>
            </div>

            <div class="pet-bottom">
              <div class="pet-bottom-row">
                <button class="btn-secondary" id="btnOpenShop">
                  üõí –ú–∞–≥–∞–∑–∏–Ω
                </button>
                <button class="btn-secondary" id="btnToLevels">
                  üéÆ –ò–≥—Ä–∞—Ç—å
                </button>
              </div>
            </div>
          </div>
        </div>

        <div class="footer-sticky">
          <button class="btn-primary" id="btnQuickCare">
            –ü–æ–≥–ª–∞–¥–∏—Ç—å (+–Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ)
          </button>
        </div>
      </div>
    </section>

    <!-- SCREEN: Level select -->
    <section class="screen" id="screen-level-select">
      <div class="screen-inner">
        <div class="card">
          <div class="card-content">
            <div class="card-title-row">
              <div class="card-title">
                –£—Ä–æ–≤–Ω–∏ "3 –≤ —Ä—è–¥"
                <span>üíé</span>
              </div>
              <button class="btn-secondary" id="btnBackToPetFromLevels">
                ‚Üê –ö –ø–∏—Ç–æ–º—Ü—É
              </button>
            </div>
            <div class="card-subtitle">
              –°–æ–±–∏—Ä–∞–π—Ç–µ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏, —á—Ç–æ–±—ã –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –º–æ–Ω–µ—Ç—ã –¥–ª—è –ø–∏—Ç–æ–º—Ü–∞.
            </div>

            <div class="level-grid" id="levelGrid">
              <!-- –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è —Å–∫—Ä–∏–ø—Ç–æ–º -->
            </div>

            <p class="text-soft mt-xs">
              –ó–∞ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è –≤—ã –ø–æ–ª—É—á–∞–µ—Ç–µ <strong>10 –º–æ–Ω–µ—Ç</strong>.
            </p>
          </div>
        </div>
      </div>
    </section>

    <!-- SCREEN: Match-3 -->
    <section class="screen" id="screen-match3">
      <div class="screen-inner">
        <div class="card">
          <div class="card-content">
            <div class="match-top-row">
              <button class="btn-secondary" id="btnMatchBack">
                ‚Üê –£—Ä–æ–≤–Ω–∏
              </button>
              <div class="match-info-chip">
                –•–æ–¥—ã: <strong id="movesLeft">0</strong>
              </div>
              <div class="match-info-chip">
                –û—á–∫–∏: <strong id="scoreValue">0</strong>
              </div>
            </div>

            <div class="match-info-chip mt-xs" style="justify-content:center;">
              –¶–µ–ª—å: <strong id="scoreTargetLabel">100 –æ—á–∫–æ–≤</strong>
            </div>

            <div class="match-board-wrap">
              <div class="match-board" id="matchBoard">
                <!-- –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è —Å–∫—Ä–∏–ø—Ç–æ–º -->
              </div>
            </div>

            <div class="match-message" id="matchMessage">
              –ö–æ—Å–Ω–∏—Ç–µ—Å—å –¥–≤—É—Ö —Å–æ—Å–µ–¥–Ω–∏—Ö —Ñ–∏—à–µ–∫, —á—Ç–æ–±—ã –ø–æ–º–µ–Ω—è—Ç—å –∏—Ö –º–µ—Å—Ç–∞–º–∏.
            </div>

            <div class="match-bottom">
              <button class="btn-secondary" id="btnRestartLevel">
                ‚Üª –ó–∞–Ω–æ–≤–æ
              </button>
              <button class="btn-secondary" id="btnMatchHint">
                üí° –ü–æ–¥—Å–∫–∞–∑–∫–∞
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- SHOP OVERLAY -->
  <div class="overlay" id="shopOverlay">
    <div class="shop-panel">
      <div class="shop-header">
        <div class="shop-title">
          üõí –ú–∞–≥–∞–∑–∏–Ω
        </div>
        <div class="match-info-chip">
          –ú–æ–Ω–µ—Ç—ã: <strong id="shopCoins">0</strong>
        </div>
      </div>

      <div class="shop-tabs">
        <button class="shop-tab active" data-tab="food">–ï–¥–∞</button>
        <button class="shop-tab" data-tab="toys">–ò–≥—Ä—É—à–∫–∏</button>
      </div>

      <div class="shop-items" id="shopItems">
        <!-- –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è —Å–∫—Ä–∏–ø—Ç–æ–º -->
      </div>

      <div class="shop-footer">
        <button class="btn-secondary" id="btnCloseShop">
          –ó–∞–∫—Ä—ã—Ç—å
        </button>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  const tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
  if (tg) {
    try {
      tg.ready();
      tg.expand();
      if (tg.setBackgroundColor) tg.setBackgroundColor("#f9f4f0");
    } catch (e) {
      console.warn("Telegram WebApp init error", e);
    }
  }

  const STORAGE_KEY = "homescape_pet_match3_state_v1";

  const SCREENS = {
    petSelect: document.getElementById("screen-pet-select"),
    petName: document.getElementById("screen-pet-name"),
    petMain: document.getElementById("screen-pet-main"),
    levelSelect: document.getElementById("screen-level-select"),
    match3: document.getElementById("screen-match3"),
  };

  function showScreen(key) {
    Object.values(SCREENS).forEach(el => el.classList.remove("active"));
    if (SCREENS[key]) SCREENS[key].classList.add("active");
  }

  const els = {
    btnClose: document.getElementById("btnClose"),
    userAvatar: document.getElementById("userAvatar"),
    userName: document.getElementById("userName"),
    headerCoins: document.getElementById("headerCoins"),
    btnPetSelectNext: document.getElementById("btnPetSelectNext"),
    petCards: document.querySelectorAll(".pet-card"),
    petNameSubtitle: document.getElementById("petNameSubtitle"),
    petNameInput: document.getElementById("petNameInput"),
    btnCreatePet: document.getElementById("btnCreatePet"),
    petNameLabel: document.getElementById("petNameLabel"),
    coinsChip: document.getElementById("coinsChip"),
    petEmoji: document.getElementById("petEmoji"),
    petSprite: document.getElementById("petSprite"),
    petHeart: document.getElementById("petHeart"),
    moodLabel: document.getElementById("moodLabel"),
    satietyText: document.getElementById("satietyText"),
    satietyBar: document.getElementById("satietyBar"),
    moodText: document.getElementById("moodText"),
    moodBar: document.getElementById("moodBar"),
    btnQuickCare: document.getElementById("btnQuickCare"),
    btnOpenShop: document.getElementById("btnOpenShop"),
    btnToLevels: document.getElementById("btnToLevels"),
    shopOverlay: document.getElementById("shopOverlay"),
    shopTabs: document.querySelectorAll(".shop-tab"),
    shopItems: document.getElementById("shopItems"),
    shopCoins: document.getElementById("shopCoins"),
    btnCloseShop: document.getElementById("btnCloseShop"),
    levelGrid: document.getElementById("levelGrid"),
    btnBackToPetFromLevels: document.getElementById("btnBackToPetFromLevels"),
    btnMatchBack: document.getElementById("btnMatchBack"),
    btnRestartLevel: document.getElementById("btnRestartLevel"),
    btnMatchHint: document.getElementById("btnMatchHint"),
    matchBoard: document.getElementById("matchBoard"),
    movesLeft: document.getElementById("movesLeft"),
    scoreValue: document.getElementById("scoreValue"),
    scoreTargetLabel: document.getElementById("scoreTargetLabel"),
    matchMessage: document.getElementById("matchMessage"),
  };

  function showAlert(msg) {
    if (tg && tg.showAlert) tg.showAlert(msg);
    else alert(msg);
  }

  const defaultState = {
    petType: null,
    petName: "",
    coins: 0,
    satiety: 100,
    mood: 100,
    satietyMax: 100,
    moodMax: 100,
    lastDecayTs: Date.now(),
    items: [],
    completedLevels: [],
  };

  let state = { ...defaultState };
  let currentLevelIndex = null;
  let matchBoard = [];
  let matchRows = 0;
  let matchCols = 0;
  let matchMovesLeft = 0;
  let matchScore = 0;
  let matchTarget = 100;
  let selectedCell = null;
  let decayTimer = null;

  const MATCH_PIECES = ["üçé","üçã","üçá","üçì","üå∏","üíé"];

  const LEVELS = [
    { id: 1, name: "–ö–ª–∞—Å—Å–∏–∫–∞",  desc: "7√ó9",           rows: 7, cols: 9, mask: null, moves: 18, target: 120 },
    { id: 2, name: "–¢—Ä–µ—É–≥–æ–ª–∫–∞", desc: "—Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫",   rows: 8, cols: 8, mask: "triangle", moves: 20, target: 140 },
    { id: 3, name: "–ö–æ—Ä–∏–¥–æ—Ä",   desc: "5√ó9 + –±–ª–æ–∫–∏",   rows: 5, cols: 9, mask: "obstacles", moves: 16, target: 110 },
    { id: 4, name: "–°–µ—Ä–¥—Ü–µ",    desc: "–≤ —Ñ–æ—Ä–º–µ —Å–µ—Ä–¥—Ü–∞",rows: 8, cols: 8, mask: "heart", moves: 22, target: 160 },
    { id: 5, name: "–¢—è–∂—ë–ª—ã–π –ø–æ–ª",desc: "8√ó8 –±–ª–æ–∫–∏",    rows: 8, cols: 8, mask: "blocks", moves: 20, target: 150 },
    { id: 6, name: "–£—é—Ç–Ω—ã–π –¥–æ–º", desc:"S-–ø–æ–ª–µ",       rows: 7, cols: 7, mask: "snake", moves: 18, target: 130 },
    { id: 7, name: "–ë–∞–ª–∫–æ–Ω",     desc:"—É–∑–∫–æ–µ –ø–æ–ª–µ",    rows: 9, cols: 5, mask: null, moves: 15, target: 120 },
    { id: 8, name: "–ó–∏–≥–∑–∞–≥",     desc:"–≤–æ–ª–Ω–∏—Å—Ç–æ–µ",     rows: 7, cols: 7, mask: "zigzag", moves: 18, target: 140 },
    { id: 9, name: "–õ–µ—Å—Ç–Ω–∏—Ü–∞",   desc:"—Å—Ç—É–ø–µ–Ω—å–∫–∏",     rows: 8, cols: 8, mask: "stairs", moves: 20, target: 150 },
    { id:10, name:"–¢–µ—Ä–∞—Å—Å–∞",     desc:"–ø—Ä–æ—Å—Ç–æ—Ä–Ω–æ–µ",    rows: 8, cols: 9, mask: null, moves: 22, target: 170 },
  ];

  const SHOP_ITEMS = {
    food: [
      { id:"fish",   name:"–†—ã–±–∫–∞",  emoji:"üêü", price:20, satiety:+30, mood:+10,
        desc:"–õ—é–±–∏–º–∞—è —Ä—ã–±–∫–∞, –±—ã—Å—Ç—Ä–æ –Ω–∞—Å—ã—â–∞–µ—Ç –∏ –ø–æ–¥–Ω–∏–º–∞–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ." },
      { id:"cake",   name:"–¢–æ—Ä—Ç",   emoji:"üç∞", price:50, satiety:+50, mood:+30,
        desc:"–ü—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–π –¥–µ—Å–µ—Ä—Ç –¥–ª—è –æ—Å–æ–±–æ–≥–æ —Å–ª—É—á–∞—è." },
      { id:"snack",  name:"–õ–∞–∫–æ–º—Å—Ç–≤–æ", emoji:"üç™", price:15, satiety:+20, mood:+15,
        desc:"–ù–µ–±–æ–ª—å—à–æ–µ –ø–æ–æ—â—Ä–µ–Ω–∏–µ –∑–∞ –∏–≥—Ä—É." },
    ],
    toys: [
      { id:"ball",   name:"–ú—è—á–∏–∫", emoji:"‚öΩ", price:15, satiety:+0, mood:+25,
        desc:"–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –∏–≥—Ä—É—à–∫–∞, –ø–∏—Ç–æ–º–µ—Ü –±—É–¥–µ—Ç –ø—Ä—ã–≥–∞—Ç—å –æ—Ç —Ä–∞–¥–æ—Å—Ç–∏." },
      { id:"mouse",  name:"–ú—ã—à–∫–∞", emoji:"üß∏", price:25, satiety:+0, mood:+35,
        desc:"–ú—è–≥–∫–∞—è –∏–≥—Ä—É—à–∫–∞, —á—Ç–æ–±—ã –æ–±–Ω–∏–º–∞—Ç—å—Å—è –∏ –∏–≥—Ä–∞—Ç—å." },
      { id:"tower",  name:"–î–æ–º–∏–∫", emoji:"üè∞", price:60, satiety:+0, mood:+50,
        desc:"–ù–æ–≤—ã–π –¥–æ–º–∏–∫, –≤ –∫–æ—Ç–æ—Ä–æ–º —Ç–∞–∫ —É—é—Ç–Ω–æ –∂–∏—Ç—å." },
    ],
  };

  function saveState() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    } catch (e) {
      console.warn("save failed", e);
    }
  }

  function loadState() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      const parsed = JSON.parse(raw);
      state = { ...defaultState, ...parsed };
      if (!Array.isArray(state.items)) state.items = [];
      if (!Array.isArray(state.completedLevels)) state.completedLevels = [];
      if (!state.lastDecayTs) state.lastDecayTs = Date.now();
    } catch (e) {
      console.warn("load failed", e);
    }
  }

  function initUserInfo() {
    if (!tg || !tg.initDataUnsafe || !tg.initDataUnsafe.user) {
      els.userName.textContent = "–ì–æ—Å—Ç—å";
      els.userAvatar.textContent = "üß∏";
      return;
    }
    const u = tg.initDataUnsafe.user;
    const name = ((u.first_name || "") + " " + (u.last_name || "")).trim();
    const display = name || u.username || "–ì–æ—Å—Ç—å";
    els.userName.textContent = display;
    els.userAvatar.textContent = (display[0] || "üôÇ").toUpperCase();
    if (!els.petNameInput.value) {
      els.petNameInput.placeholder = `–ù–∞–ø—Ä–∏–º–µ—Ä: ${display.split(" ")[0] || "–ü—É—à–æ–∫"}`;
    }
  }

  function applyDecay() {
    const now = Date.now();
    const diff = now - (state.lastDecayTs || now);
    const step = 30 * 60 * 1000;
    if (diff < step) return;
    const steps = Math.floor(diff / step);
    const perStepSatiety = 6;
    const perStepMood = 5;
    state.satiety = Math.max(0, state.satiety - steps * perStepSatiety);
    state.mood = Math.max(0, state.mood - steps * perStepMood);
    state.lastDecayTs = now;
    updatePetUI();
    saveState();
  }

  function startDecayTimer() {
    if (decayTimer) clearInterval(decayTimer);
    decayTimer = setInterval(applyDecay, 60 * 1000);
  }

  function getPetEmojiByMood() {
    if (!state.petType) return "üêæ";
    const ratioSat = state.satiety / state.satietyMax;
    const ratioMood = state.mood / state.moodMax;
    const minRatio = Math.min(ratioSat, ratioMood);

    if (minRatio <= 0.25) {
      if (state.petType === "cat") return "üòø";
      if (state.petType === "dog") return "üê∂";
      if (state.petType === "hamster") return "üòî";
    } else if (minRatio <= 0.55) {
      if (state.petType === "cat") return "üò∫";
      if (state.petType === "dog") return "üê∂";
      if (state.petType === "hamster") return "üôÇ";
    } else {
      if (state.petType === "cat") return "üòª";
      if (state.petType === "dog") return "üêï";
      if (state.petType === "hamster") return "ü•∞";
    }
    return "üêæ";
  }

  function updatePetUI() {
    els.headerCoins.textContent = state.coins;
    els.coinsChip.textContent = state.coins;
    els.petNameLabel.textContent = state.petName || "–ü–∏—Ç–æ–º–µ—Ü";
    els.petEmoji.textContent = getPetEmojiByMood();

    const s = Math.max(0, Math.min(state.satiety, state.satietyMax));
    const m = Math.max(0, Math.min(state.mood, state.moodMax));
    els.satietyText.textContent = `${s} / ${state.satietyMax}`;
    els.moodText.textContent = `${m} / ${state.moodMax}`;

    const sPerc = state.satietyMax > 0 ? (s / state.satietyMax) * 100 : 0;
    const mPerc = state.moodMax > 0 ? (m / state.moodMax) * 100 : 0;
    els.satietyBar.style.width = `${Math.min(100, Math.max(0, sPerc))}%`;
    els.moodBar.style.width = `${Math.min(100, Math.max(0, mPerc))}%`;

    const ratio = Math.min(sPerc, mPerc) / 100;
    if (ratio <= 0.25) {
      els.moodLabel.textContent = "–ü–∏—Ç–æ–º–µ—Ü –≤—ã–≥–ª—è–¥–∏—Ç –≥—Ä—É—Å—Ç–Ω—ã–º... –ù–∞–∫–æ—Ä–º–∏—Ç–µ –∏ –ø–æ–∏–≥—Ä–∞–π—Ç–µ —Å –Ω–∏–º üíî";
    } else if (ratio <= 0.6) {
      els.moodLabel.textContent = "–ü–∏—Ç–æ–º—Ü—É –Ω–µ–º–Ω–æ–≥–æ —Å–∫—É—á–Ω–æ. –ù—É–∂–Ω—ã –∑–∞–±–æ—Ç–∞ –∏ –∏–≥—Ä–∞ üòä";
    } else {
      els.moodLabel.textContent = "–ü–∏—Ç–æ–º–µ—Ü —Å—á–∞—Å—Ç–ª–∏–≤ –∏ –Ω–∞—Å–ª–∞–∂–¥–∞–µ—Ç—Å—è —É—é—Ç–æ–º –¥–æ–º–∞ ‚ú®";
    }
  }

  function spawnHeart() {
    els.petHeart.style.display = "block";
    els.petHeart.textContent = "üíõ";
    setTimeout(() => {
      els.petHeart.style.display = "none";
    }, 800);
  }

  function bouncePet() {
    els.petSprite.classList.remove("pet-bounce");
    void els.petSprite.offsetWidth;
    els.petSprite.classList.add("pet-bounce");
  }

  function carePet({ satietyDelta = 0, moodDelta = 0 }) {
    state.satiety = Math.max(0, Math.min(state.satietyMax, state.satiety + satietyDelta));
    state.mood = Math.max(0, Math.min(state.moodMax, state.mood + moodDelta));
    state.lastDecayTs = Date.now();
    updatePetUI();
    bouncePet();
    spawnHeart();
    saveState();
  }

  function buildShopItems(tab) {
    const list = SHOP_ITEMS[tab] || [];
    els.shopItems.innerHTML = "";
    list.forEach(item => {
      const row = document.createElement("div");
      row.className = "shop-item";
      row.innerHTML = `
        <div class="shop-icon">${item.emoji}</div>
        <div class="shop-body">
          <div class="shop-name">${item.name}</div>
          <div class="shop-desc">${item.desc}</div>
          <div class="shop-meta">
            <span class="shop-price">üí∞ ${item.price}</span>
            <span class="shop-effect">
              ${item.satiety ? "–°—ã—Ç–æ—Å—Ç—å +" + item.satiety + " " : ""}${item.mood ? "–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ +" + item.mood : ""}
            </span>
          </div>
        </div>
        <div class="shop-action">
          <button class="shop-btn" data-item="${item.id}" data-tab="${tab}">
            –ö—É–ø–∏—Ç—å
          </button>
        </div>
      `;
      els.shopItems.appendChild(row);
    });

    els.shopItems.querySelectorAll(".shop-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-item");
        const t = btn.getAttribute("data-tab");
        buyShopItem(t, id);
      });
    });
  }

  function buyShopItem(tab, id) {
    const list = SHOP_ITEMS[tab] || [];
    const item = list.find(i => i.id === id);
    if (!item) return;

    if (state.coins < item.price) {
      showAlert("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –º–æ–Ω–µ—Ç –¥–ª—è –ø–æ–∫—É–ø–∫–∏ üòø");
      return;
    }
    state.coins -= item.price;
    state.items.push(id);

    carePet({ satietyDelta: item.satiety, moodDelta: item.mood });
    updatePetUI();
    els.shopCoins.textContent = state.coins;
    saveState();

    let msg;
    if (tab === "food") {
      msg = "–ü–∏—Ç–æ–º–µ—Ü –≤–∫—É—Å–Ω–æ –ø–æ–µ–ª –∏ –¥–æ–≤–æ–ª–µ–Ω üçΩÔ∏è";
    } else {
      msg = "–ü–∏—Ç–æ–º–µ—Ü –∏–≥—Ä–∞–µ—Ç —Å –Ω–æ–≤–æ–π –∏–≥—Ä—É—à–∫–æ–π –∏ —Å—á–∞—Å—Ç–ª–∏–≤ üß∏";
    }
    showAlert(msg);
  }

  function buildLevels() {
    els.levelGrid.innerHTML = "";
    LEVELS.forEach((lvl, idx) => {
      const unlocked = idx === 0 || state.completedLevels.includes(LEVELS[idx - 1].id);
      const completed = state.completedLevels.includes(lvl.id);
      const card = document.createElement("button");
      card.type = "button";
      card.className = "level-card" + (unlocked ? "" : " locked");
      card.dataset.index = String(idx);
      card.innerHTML = `
        <div class="level-badge">${lvl.id}</div>
        <div class="level-name">${lvl.name}</div>
        <div class="level-meta">
          ${lvl.desc}<br>
          ${completed ? "‚úÖ –ø—Ä–æ–π–¥–µ–Ω" : unlocked ? "–î–æ—Å—Ç—É–ø–µ–Ω" : "üîí –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω"}
        </div>
      `;
      if (unlocked) {
        card.addEventListener("click", () => {
          startLevel(idx);
        });
      }
      els.levelGrid.appendChild(card);
    });
  }

  function makeMask(type, rows, cols) {
    const mask = [];
    for (let r = 0; r < rows; r++) {
      mask[r] = [];
      for (let c = 0; c < cols; c++) mask[r][c] = true;
    }
    if (!type) return mask;

    if (type === "triangle") {
      for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
          if (c > r) mask[r][c] = false;
        }
      }
    } else if (type === "obstacles") {
      for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) mask[r][c] = true;
      }
      mask[2][3] = false;
      mask[2][5] = false;
    } else if (type === "heart") {
      for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) mask[r][c] = false;
      }
      const mid = Math.floor(cols / 2);
      for (let c = mid - 2; c <= mid + 2; c++) mask[1][c] = true;
      mask[0][mid-1] = true;
      mask[0][mid+1] = true;
      for (let r = 2; r < rows; r++) {
        const spread = rows - r;
        for (let c = mid - spread; c <= mid + spread; c++) {
          mask[r][c] = true;
        }
      }
    } else if (type === "blocks") {
      for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) mask[r][c] = true;
      }
      for (let r = 1; r < rows - 1; r++) {
        if (r % 2 === 0) {
          mask[r][1] = false;
          mask[r][cols-2] = false;
        }
      }
    } else if (type === "snake") {
      for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) mask[r][c] = false;
      }
      for (let r = 0; r < rows; r++) {
        if (r % 2 === 0) {
          for (let c = 0; c < cols; c++) mask[r][c] = true;
        } else {
          mask[r][0] = true;
          mask[r][cols-1] = true;
        }
      }
    } else if (type === "zigzag") {
      for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
          const offset = (r % 2 === 0) ? 1 : 0;
          mask[r][c] = (c + offset) % 3 !== 0;
        }
      }
    } else if (type === "stairs") {
      for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
          if (c < r) mask[r][c] = false;
        }
      }
    }

    return mask;
  }

  function randomPiece() {
    const idx = Math.floor(Math.random() * MATCH_PIECES.length);
    return MATCH_PIECES[idx];
  }

  function hasMatchAt(board, r, c) {
    const rows = board.length;
    const cols = board[0].length;
    const val = board[r][c];
    if (!val) return false;

    let count = 1;
    let cc = c - 1;
    while (cc >= 0 && board[r][cc] === val) { count++; cc--; }
    cc = c + 1;
    while (cc < cols && board[r][cc] === val) { count++; cc++; }
    if (count >= 3) return true;

    count = 1;
    let rr = r - 1;
    while (rr >= 0 && board[rr][c] === val) { count++; rr--; }
    rr = r + 1;
    while (rr < rows && board[rr][c] === val) { count++; rr++; }
    return count >= 3;
  }

  function createInitialBoard(rows, cols, mask) {
    const board = [];
    for (let r = 0; r < rows; r++) {
      board[r] = [];
      for (let c = 0; c < cols; c++) {
        if (mask && !mask[r][c]) {
          board[r][c] = null;
          continue;
        }
        let piece;
        do {
          piece = randomPiece();
          board[r][c] = piece;
        } while (hasMatchAt(board, r, c));
      }
    }
    return board;
  }

  function renderBoard() {
    els.matchBoard.innerHTML = "";
    els.matchBoard.style.gridTemplateColumns = `repeat(${matchCols}, 1fr)`;
    els.matchBoard.style.gridTemplateRows = `repeat(${matchRows}, auto)`;

    for (let r = 0; r < matchRows; r++) {
      for (let c = 0; c < matchCols; c++) {
        const val = matchBoard[r][c];
        const cell = document.createElement("div");
        cell.className = "match-cell";
        cell.dataset.row = String(r);
        cell.dataset.col = String(c);
        if (val === null) {
          cell.classList.add("empty");
          cell.textContent = "";
        } else {
          cell.textContent = val;
        }
        cell.addEventListener("click", () => onCellClick(r, c));
        els.matchBoard.appendChild(cell);
      }
    }
  }

  function findMatches(board) {
    const rows = board.length;
    const cols = board[0].length;
    const toRemove = [];

    for (let r = 0; r < rows; r++) {
      let run = 1;
      for (let c = 1; c <= cols; c++) {
        const cur = c < cols ? board[r][c] : null;
        const prev = board[r][c-1];
        if (cur && cur === prev) {
          run++;
        } else {
          if (prev && run >= 3) {
            for (let k = 0; k < run; k++) {
              toRemove.push([r, c-1-k]);
            }
          }
          run = 1;
        }
      }
    }

    for (let c = 0; c < cols; c++) {
      let run = 1;
      for (let r = 1; r <= rows; r++) {
        const cur = r < rows ? board[r][c] : null;
        const prev = board[r-1][c];
        if (cur && cur === prev) {
          run++;
        } else {
          if (prev && run >= 3) {
            for (let k = 0; k < run; k++) {
              toRemove.push([r-1-k, c]);
            }
          }
          run = 1;
        }
      }
    }

    const unique = [];
    const set = new Set();
    toRemove.forEach(([r, c]) => {
      const key = r + ":" + c;
      if (!set.has(key)) {
        set.add(key);
        unique.push([r, c]);
      }
    });
    return unique;
  }

  function applyGravity(board) {
    const rows = board.length;
    const cols = board[0].length;
    for (let c = 0; c < cols; c++) {
      let writeRow = rows - 1;
      for (let r = rows - 1; r >= 0; r--) {
        if (board[r][c] !== null) {
          board[writeRow][c] = board[r][c];
          if (writeRow !== r) board[r][c] = null;
          writeRow--;
        }
      }
      for (let r = writeRow; r >= 0; r--) {
        if (board[r][c] !== null) continue;
        board[r][c] = randomPiece();
      }
    }
  }

  function updateMatchInfo() {
    els.movesLeft.textContent = matchMovesLeft;
    els.scoreValue.textContent = matchScore;
    els.scoreTargetLabel.textContent = `${matchTarget} –æ—á–∫–æ–≤`;
  }

  function onCellClick(r, c) {
    if (matchMovesLeft <= 0) return;
    if (matchBoard[r][c] === null) return;

    if (!selectedCell) {
      selectedCell = { r, c };
      highlightSelected();
      return;
    }

    if (selectedCell.r === r && selectedCell.c === c) {
      selectedCell = null;
      highlightSelected();
      return;
    }

    const dr = Math.abs(selectedCell.r - r);
    const dc = Math.abs(selectedCell.c - c);
    if (dr + dc !== 1) {
      selectedCell = { r, c };
      highlightSelected();
      return;
    }

    trySwap(selectedCell.r, selectedCell.c, r, c);
    selectedCell = null;
    highlightSelected();
  }

  function highlightSelected() {
    const cells = els.matchBoard.querySelectorAll(".match-cell");
    cells.forEach(cell => cell.classList.remove("selected"));
    if (!selectedCell) return;
    const sel = Array.from(cells).find(cell =>
      Number(cell.dataset.row) === selectedCell.r &&
      Number(cell.dataset.col) === selectedCell.c
    );
    if (sel) sel.classList.add("selected");
  }

  function trySwap(r1, c1, r2, c2) {
    const val1 = matchBoard[r1][c1];
    const val2 = matchBoard[r2][c2];
    matchBoard[r1][c1] = val2;
    matchBoard[r2][c2] = val1;

    const hasMatch = findMatches(matchBoard).length > 0;
    if (!hasMatch) {
      matchBoard[r1][c1] = val1;
      matchBoard[r2][c2] = val2;
      renderBoard();
      els.matchMessage.textContent = "–ù–µ—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π —Ö–æ–¥.";
      return;
    }

    matchMovesLeft--;
    processMatches();
  }

  function processMatches() {
    let totalRemoved = 0;
    function step() {
      const matches = findMatches(matchBoard);
      if (matches.length === 0) {
        if (totalRemoved > 0) {
          matchScore += totalRemoved * 10;
          updateMatchInfo();
          if (matchScore >= matchTarget) levelCompleted();
          else if (matchMovesLeft <= 0) levelFailed();
        } else {
          updateMatchInfo();
        }
        renderBoard();
        return;
      }
      totalRemoved += matches.length;

      matches.forEach(([r, c]) => {
        const cell = els.matchBoard.querySelector(`.match-cell[data-row="${r}"][data-col="${c}"]`);
        if (cell) {
          cell.classList.add("remove");
        }
      });

      setTimeout(() => {
        matches.forEach(([r, c]) => {
          matchBoard[r][c] = null;
        });
        applyGravity(matchBoard);
        renderBoard();
        setTimeout(step, 100);
      }, 280);
    }
    step();
  }

  function levelCompleted() {
    els.matchMessage.textContent = "–£—Ä–æ–≤–µ–Ω—å –ø—Ä–æ–π–¥–µ–Ω! –ü–∏—Ç–æ–º–µ—Ü –ø–æ–ª—É—á–∏–ª –º–æ–Ω–µ—Ç–∫–∏ ü•≥";
    if (!state.completedLevels.includes(LEVELS[currentLevelIndex].id)) {
      state.completedLevels.push(LEVELS[currentLevelIndex].id);
    }
    state.coins += 10;
    updatePetUI();
    saveState();
  }

  function levelFailed() {
    els.matchMessage.textContent = "–•–æ–¥—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑ üíî";
  }

  function startLevel(idx) {
    currentLevelIndex = idx;
    const lvl = LEVELS[idx];
    matchRows = lvl.rows;
    matchCols = lvl.cols;
    matchMovesLeft = lvl.moves;
    matchScore = 0;
    matchTarget = lvl.target;

    const mask = makeMask(lvl.mask, matchRows, matchCols);
    matchBoard = createInitialBoard(matchRows, matchCols, mask);

    updateMatchInfo();
    renderBoard();
    els.matchMessage.textContent = "–°–æ–±–∏—Ä–∞–π—Ç–µ 3+ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö —Ñ–∏—à–µ–∫ –∑–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ —á–∏—Å–ª–æ —Ö–æ–¥–æ–≤.";
    showScreen("match3");
  }

  function restartCurrentLevel() {
    if (currentLevelIndex == null) return;
    startLevel(currentLevelIndex);
  }

  function initPetSelect() {
    let selectedPet = null;
    els.petCards.forEach(card => {
      card.addEventListener("click", () => {
        selectedPet = card.dataset.pet;
        state.petType = selectedPet;
        els.petCards.forEach(c => c.classList.remove("selected"));
        card.classList.add("selected");
        els.btnPetSelectNext.disabled = false;
      });
    });

    els.btnPetSelectNext.addEventListener("click", () => {
      if (!state.petType) return;
      const typeName =
        state.petType === "cat" ? "–∫–æ—à–∫—É" :
        state.petType === "dog" ? "—Å–æ–±–∞–∫—É" : "—Ö–æ–º—è–∫–∞";
      els.petNameSubtitle.textContent =
        `–í–∞—à ${typeName} –∂–¥—ë—Ç —Ç—ë–ø–ª–æ–µ –∏–º—è.`;
      showScreen("petName");
    });

    els.btnCreatePet.addEventListener("click", () => {
      const name = els.petNameInput.value.trim();
      if (!name) {
        showAlert("–î–∞–π—Ç–µ –ø–∏—Ç–æ–º—Ü—É –∏–º—è, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å üß°");
        return;
      }
      state.petName = name;
      state.satiety = 100;
      state.mood = 100;
      state.lastDecayTs = Date.now();
      updatePetUI();
      saveState();
      showScreen("petMain");
      startDecayTimer();
    });

    els.petNameInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        els.btnCreatePet.click();
      }
    });
  }

  function initApp() {
    loadState();
    initUserInfo();
    updatePetUI();
    buildLevels();
    startDecayTimer();

    if (state.petType && state.petName) {
      applyDecay();
      updatePetUI();
      showScreen("petMain");
    } else if (state.petType && !state.petName) {
      showScreen("petName");
    } else {
      showScreen("petSelect");
    }

    initPetSelect();

    els.btnQuickCare.addEventListener("click", () => {
      carePet({ satietyDelta: 0, moodDelta: 10 });
    });

    els.btnOpenShop.addEventListener("click", () => {
      els.shopOverlay.classList.add("visible");
      els.shopCoins.textContent = state.coins;
      els.shopTabs.forEach(t => t.classList.remove("active"));
      const first = els.shopTabs[0];
      first.classList.add("active");
      buildShopItems(first.dataset.tab);
    });

    els.btnCloseShop.addEventListener("click", () => {
      els.shopOverlay.classList.remove("visible");
    });

    els.shopOverlay.addEventListener("click", (e) => {
      if (e.target === els.shopOverlay) {
        els.shopOverlay.classList.remove("visible");
      }
    });

    els.shopTabs.forEach(tab => {
      tab.addEventListener("click", () => {
        els.shopTabs.forEach(t => t.classList.remove("active"));
        tab.classList.add("active");
        buildShopItems(tab.dataset.tab);
      });
    });

    els.btnToLevels.addEventListener("click", () => {
      buildLevels();
      showScreen("levelSelect");
    });

    els.btnBackToPetFromLevels.addEventListener("click", () => {
      showScreen("petMain");
    });

    els.btnMatchBack.addEventListener("click", () => {
      buildLevels();
      showScreen("levelSelect");
    });

    els.btnRestartLevel.addEventListener("click", () => {
      restartCurrentLevel();
    });

    els.btnMatchHint.addEventListener("click", () => {
      showAlert("–ò—â–∏—Ç–µ –º–µ—Å—Ç–∞, –≥–¥–µ –º–æ–∂–Ω–æ —Å–æ–±—Ä–∞—Ç—å 3+ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö —Ñ–∏—à–∫–∏. –ù–∞—á–Ω–∏—Ç–µ —Å –Ω–∏–∂–Ω–∏—Ö —Ä—è–¥–æ–≤ ‚Äî —Ç–∞–∫ –ø–æ—è–≤–ª—è—é—Ç—Å—è –Ω–æ–≤—ã–µ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏.");
    });

    els.btnClose.addEventListener("click", () => {
      if (tg && tg.close) {
        tg.close();
      } else {
        showAlert("–í Telegram Mini App –∑–¥–µ—Å—å –æ–∫–Ω–æ –∑–∞–∫—Ä–æ–µ—Ç—Å—è, –∞ –≤ –±—Ä–∞—É–∑–µ—Ä–µ ‚Äî –Ω–µ –º–æ–∂–µ–º üôÇ");
      }
    });
  }

  document.addEventListener("DOMContentLoaded", initApp);
})();
</script>
</body>
</html>

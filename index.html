<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Homescapes Pet & Match-3 TWA</title>
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <!-- Telegram WebApp -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root {
      --bg-main: #f9f3ef;
      --bg-card: #ffffff;
      --accent: #ff9f6b;
      --accent-strong: #ff7a5c;
      --accent-soft: rgba(255, 159, 107, 0.18);
      --text-main: #2f3542;
      --text-soft: #6b7280;
      --coin-color: #fbbf24;
      --good: #22c55e;
      --bad: #f97373;
      --shadow-soft: 0 16px 40px rgba(0, 0, 0, 0.18);
      --radius-lg: 22px;
      --radius-xl: 26px;
      --safe-top: env(safe-area-inset-top, 12px);
      --safe-bottom: env(safe-area-inset-bottom, 12px);
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #ffe9d2 0, #f9f3ef 45%, #f0e4dd 100%);
      color: var(--text-main);
    }

    body {
      display: flex;
      justify-content: center;
      align-items: stretch;
    }

    .app {
      position: relative;
      width: 100%;
      max-width: 480px;
      height: 100vh;
      height: 100dvh;
      padding: calc(var(--safe-top) + 8px) 12px calc(var(--safe-bottom) + 8px) 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    /* Header (—É—á—ë—Ç –ø–∞–Ω–µ–ª–∏ Telegram) */
    .app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.9);
      box-shadow: 0 12px 28px rgba(0, 0, 0, 0.12);
      backdrop-filter: blur(14px);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .header-btn {
      border-radius: 999px;
      border: none;
      outline: none;
      padding: 6px 8px;
      cursor: pointer;
      background: rgba(15, 23, 42, 0.04);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }

    .header-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-soft);
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 999px;
      background: linear-gradient(135deg, #ffd28f, #ff9f6b);
      color: #fff;
      font-size: 12px;
      font-weight: 700;
    }

    .coin-circle {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #fff7d6 0, #fbbf24 55%, #f59e0b 100%);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      color: #78350f;
      font-weight: 900;
    }

    /* Screen container */
    .screens {
      flex: 1;
      position: relative;
      overflow: hidden;
      border-radius: var(--radius-xl);
    }

    .screen {
      position: absolute;
      inset: 0;
      display: none;
      padding: 8px 4px 4px 4px;
      transform: translateX(10px);
      opacity: 0;
      transition: opacity 0.2s ease-out, transform 0.2s ease-out;
    }

    .screen.active {
      display: block;
      opacity: 1;
      transform: translateX(0);
    }

    /* Generic card */
    .card {
      position: relative;
      height: 100%;
      border-radius: var(--radius-xl);
      background: linear-gradient(145deg, #fff7ee, #ffffff);
      box-shadow: var(--shadow-soft);
      padding: 14px 12px 12px 12px;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: -40%;
      background-image:
        radial-gradient(circle at 10% 0%, rgba(255, 171, 96, 0.18) 0, transparent 52%),
        radial-gradient(circle at 90% 0%, rgba(96, 153, 255, 0.12) 0, transparent 55%),
        radial-gradient(circle at 0% 90%, rgba(135, 255, 167, 0.16) 0, transparent 45%),
        radial-gradient(circle at 100% 90%, rgba(255, 171, 193, 0.15) 0, transparent 50%);
      opacity: 0.95;
      pointer-events: none;
    }

    .card-inner {
      position: relative;
      z-index: 1;
      height: 100%;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .card-header {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .card-title {
      font-size: 18px;
      font-weight: 700;
      color: #3b4256;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card-subtitle {
      font-size: 13px;
      color: var(--text-soft);
    }

    .btn-primary {
      border-radius: 999px;
      padding: 12px 14px;
      border: none;
      outline: none;
      cursor: pointer;
      width: 100%;
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      color: #fff;
      font-weight: 700;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      box-shadow: 0 14px 32px rgba(255, 140, 101, 0.45);
    }

    .btn-primary:active {
      transform: translateY(1px) scale(0.99);
      box-shadow: 0 6px 16px rgba(255, 140, 101, 0.35);
    }

    .btn-primary:disabled {
      opacity: 0.6;
      box-shadow: none;
      cursor: default;
    }

    .btn-secondary {
      border-radius: 999px;
      padding: 8px 12px;
      border: none;
      outline: none;
      cursor: pointer;
      background: rgba(255, 255, 255, 0.9);
      box-shadow: 0 8px 18px rgba(0, 0, 0, 0.06);
      font-size: 13px;
      font-weight: 600;
      color: #4b5563;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .btn-secondary:active {
      transform: translateY(1px);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.12);
    }

    /* Pet selection */
    .pet-select-grid {
      margin-top: 8px;
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
      flex: 1;
    }

    .pet-card {
      position: relative;
      border-radius: 20px;
      padding: 8px 6px 10px 6px;
      background: linear-gradient(145deg, #ffffff, #ffe7cf);
      box-shadow: 0 10px 26px rgba(255, 159, 107, 0.25);
      cursor: pointer;
      border: 2px solid transparent;
      transition: transform 0.14s ease, box-shadow 0.14s ease, border 0.14s ease, background 0.14s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }

    .pet-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 16px 30px rgba(255, 159, 107, 0.34);
    }

    .pet-card.selected {
      border-color: var(--accent-strong);
      background: linear-gradient(145deg, #fff0dc, #ffe2c3);
      box-shadow: 0 16px 34px rgba(255, 159, 107, 0.4);
    }

    /* ‚Äú–ù–∞—Ä–∏—Å–æ–≤–∞–Ω–Ω—ã–π‚Äù –ø–∏—Ç–æ–º–µ—Ü ‚Äî —á–∏—Å—Ç–æ CSS */
    .pet-sprite-preview {
      width: 74px;
      height: 74px;
      border-radius: 24px;
      background: radial-gradient(circle at 30% 10%, #ffffff 0, #ffe2c5 45%, #ffb784 100%);
      position: relative;
      box-shadow: inset 0 0 0 2px rgba(255, 255, 255, 0.85),
                  0 10px 22px rgba(0, 0, 0, 0.18);
      overflow: hidden;
    }

    .pet-sprite-head {
      position: absolute;
      bottom: 6px;
      left: 50%;
      transform: translateX(-50%);
      width: 52px;
      height: 46px;
      border-radius: 50px;
      background: radial-gradient(circle at 30% 10%, #ffe9d0 0, #ffc48b 60%, #f89c62 100%);
      box-shadow: 0 5px 10px rgba(0, 0, 0, 0.16);
    }

    .pet-sprite-ear {
      position: absolute;
      top: -10px;
      width: 18px;
      height: 22px;
      border-radius: 50% 50% 40% 40%;
      background: radial-gradient(circle at 30% 10%, #ffe9d0 0, #f9b376 70%);
    }

    .pet-sprite-ear.left { left: 2px; transform: rotate(-12deg); }
    .pet-sprite-ear.right { right: 2px; transform: rotate(12deg); }

    .pet-sprite-face {
      position: absolute;
      inset: 10px 8px 10px 8px;
    }

    .pet-eye {
      position: absolute;
      top: 10px;
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: #1f2933;
      box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.5);
    }
    .pet-eye.left { left: 12px; }
    .pet-eye.right { right: 12px; }

    .pet-blush {
      position: absolute;
      top: 20px;
      width: 10px;
      height: 6px;
      border-radius: 50%;
      background: rgba(252, 165, 165, 0.7);
    }
    .pet-blush.left { left: 6px; }
    .pet-blush.right { right: 6px; }

    .pet-mouth {
      position: absolute;
      bottom: 8px;
      left: 50%;
      width: 16px;
      height: 8px;
      border-radius: 0 0 14px 14px;
      border-bottom: 2px solid #1f2933;
      border-left: 2px solid transparent;
      border-right: 2px solid transparent;
      transform: translateX(-50%);
    }

    .pet-body-tag {
      font-size: 12px;
      font-weight: 600;
      color: #3f3d56;
    }

    .pet-body-sub {
      font-size: 11px;
      color: var(--text-soft);
    }

    /* Pet_NAME screen */
    .form-group {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .form-label {
      font-size: 13px;
      font-weight: 600;
      color: #4b5563;
    }

    .form-input {
      border-radius: 999px;
      border: 1.5px solid rgba(148, 163, 184, 0.5);
      padding: 9px 12px;
      font-size: 14px;
      outline: none;
      background: rgba(255, 255, 255, 0.9);
      box-shadow: 0 8px 18px rgba(0, 0, 0, 0.05);
    }

    .form-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(255, 159, 107, 0.45);
    }

    /* Main pet screen */
    .pet-main-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .pet-name-chip {
      margin: 0 auto;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.92);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.08);
      font-size: 13px;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .pet-mood-indicator {
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: rgba(255, 255, 255, 0.92);
    }

    .pet-main-layout {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 6px;
    }

    .pet-stage-wrap {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .pet-stage {
      width: 220px;
      max-width: 90%;
      aspect-ratio: 1 / 1;
      border-radius: 30px;
      background: radial-gradient(circle at 50% 15%, #fff9f4 0, #ffe4c7 45%, #ffc48b 100%);
      box-shadow: 0 18px 42px rgba(0, 0, 0, 0.22);
      position: relative;
      overflow: hidden;
    }

    .pet-stage-floor {
      position: absolute;
      inset-inline: -20%;
      bottom: -6%;
      height: 42%;
      background:
        radial-gradient(circle at 20% 0%, rgba(255, 255, 255, 0.8) 0, transparent 55%),
        radial-gradient(circle at 80% 0%, rgba(255, 255, 255, 0.9) 0, transparent 60%),
        radial-gradient(circle at 50% 20%, rgba(0, 0, 0, 0.14) 0, transparent 70%);
      opacity: 0.6;
    }

    .pet-main-sprite {
      position: absolute;
      left: 50%;
      bottom: 16%;
      transform: translateX(-50%);
      width: 130px;
      height: 124px;
    }

    .pet-main-body {
      position: absolute;
      inset: 0;
      border-radius: 42px;
      background: radial-gradient(circle at 30% 5%, #ffffff 0, #ffe4c2 45%, #ffb784 100%);
      box-shadow: inset 0 0 0 2px rgba(255, 255, 255, 0.85),
                  0 16px 28px rgba(0, 0, 0, 0.28);
      overflow: hidden;
    }

    .pet-main-head {
      position: absolute;
      bottom: 12px;
      left: 50%;
      transform: translateX(-50%);
      width: 80px;
      height: 70px;
      border-radius: 50px;
      background: radial-gradient(circle at 30% 10%, #ffe9d0 0, #ffc48b 60%, #f89c62 100%);
      box-shadow: 0 5px 14px rgba(0, 0, 0, 0.24);
    }

    .pet-main-ears {
      position: absolute;
      top: -16px;
      left: 50%;
      width: 80px;
      transform: translateX(-50%);
      height: 24px;
    }

    .pet-main-ear {
      position: absolute;
      width: 24px;
      height: 24px;
      border-radius: 60% 60% 40% 40%;
      background: radial-gradient(circle at 30% 10%, #ffe9d0 0, #f9b376 70%);
    }

    .pet-main-ear.left { left: 0; transform: rotate(-10deg); }
    .pet-main-ear.right { right: 0; transform: rotate(10deg); }

    .pet-main-face {
      position: absolute;
      inset: 14px 10px 12px 10px;
    }

    .pet-main-eye {
      position: absolute;
      top: 14px;
      width: 9px;
      height: 9px;
      border-radius: 50%;
      background: #111827;
      box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.6);
    }
    .pet-main-eye.left { left: 16px; }
    .pet-main-eye.right { right: 16px; }

    .pet-main-blush {
      position: absolute;
      top: 26px;
      width: 12px;
      height: 7px;
      border-radius: 50%;
      background: rgba(252, 165, 165, 0.7);
    }
    .pet-main-blush.left { left: 8px; }
    .pet-main-blush.right { right: 8px; }

    .pet-main-mouth {
      position: absolute;
      bottom: 10px;
      left: 50%;
      width: 20px;
      height: 10px;
      transform: translateX(-50%);
      border-radius: 0 0 20px 20px;
      border-bottom: 2px solid #111827;
    }

    .pet-main-mouth.happy {
      border-bottom-width: 3px;
    }
    .pet-main-mouth.sad {
      height: 10px;
      border-radius: 20px 20px 0 0;
      border-bottom: none;
      border-top: 2px solid #111827;
      bottom: 6px;
    }

    .pet-main-idle {
      animation: petIdle 2.8s ease-in-out infinite;
    }

    .pet-main-happy-anim {
      animation: petHappy 0.6s ease-out;
    }

    .pet-main-sad-tone {
      filter: grayscale(0.2) brightness(0.96);
    }

    .pet-main-happy-tone {
      filter: saturate(1.2) brightness(1.02);
    }

    @keyframes petIdle {
      0%   { transform: translate(-50%, 0) scale(1); }
      40%  { transform: translate(-50%, -3px) scale(1.02); }
      80%  { transform: translate(-50%, 0) scale(1); }
      100% { transform: translate(-50%, 0) scale(1); }
    }

    @keyframes petHappy {
      0% { transform: translate(-50%, 0) scale(1); }
      30%{ transform: translate(-50%, -10px) scale(1.04); }
      60%{ transform: translate(-50%, 2px) scale(0.98); }
      100%{transform: translate(-50%, 0) scale(1); }
    }

    /* Stats */
    .stats-panel {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 18px;
      padding: 8px;
      box-shadow: 0 10px 26px rgba(0, 0, 0, 0.12);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .stat-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .stat-icon {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      background: rgba(248, 250, 252, 0.9);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
    }

    .stat-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 11px;
    }

    .stat-label-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      color: var(--text-soft);
    }

    .stat-label-row strong {
      color: #374151;
    }

    .stat-bar {
      position: relative;
      width: 100%;
      height: 10px;
      border-radius: 999px;
      background: rgba(229, 231, 235, 0.9);
      overflow: hidden;
    }

    .stat-bar-fill {
      position: absolute;
      inset-block: 0;
      left: 0;
      width: 40%;
      border-radius: inherit;
      background: linear-gradient(90deg, #4ade80, #22c55e);
      box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.6);
      transition: width 0.22s ease-out;
    }

    .stat-bar-fill.mood {
      background: linear-gradient(90deg, #fb7185, #f97316);
    }

    /* Bottom pet buttons */
    .pet-bottom-bar {
      display: flex;
      gap: 8px;
      margin-top: 4px;
    }

    .pet-bottom-bar .btn-primary {
      flex: 2;
      padding-block: 11px;
      font-size: 14px;
    }

    .pet-bottom-bar .btn-secondary {
      flex: 1;
      padding-block: 9px;
      font-size: 12px;
    }

    /* Shop */
    .shop-overlay {
      position: fixed;
      inset: 0;
      display: none;
      justify-content: center;
      align-items: flex-end;
      padding: 0 10px calc(var(--safe-bottom) + 8px) 10px;
      background: rgba(15, 23, 42, 0.35);
      z-index: 20;
    }

    .shop-overlay.visible {
      display: flex;
    }

    .shop-panel {
      width: 100%;
      max-width: 480px;
      border-radius: 24px 24px 0 0;
      background: #fff7ee;
      box-shadow: 0 -16px 40px rgba(0, 0, 0, 0.35);
      padding: 10px 12px;
      max-height: 70vh;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .shop-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .shop-tabs {
      display: inline-flex;
      background: rgba(248, 250, 252, 0.9);
      border-radius: 999px;
      padding: 2px;
    }

    .shop-tab {
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      border: none;
      cursor: pointer;
      background: transparent;
      color: var(--text-soft);
    }

    .shop-tab.active {
      background: #ffffff;
      color: #111827;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.12);
      font-weight: 600;
    }

    .shop-balance {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.95);
      font-size: 12px;
      color: var(--text-soft);
    }

    .shop-items {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 4px;
    }

    .shop-item {
      border-radius: 18px;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.96), #ffe4c9);
      padding: 8px;
      display: flex;
      gap: 10px;
      align-items: center;
      box-shadow: 0 8px 18px rgba(0, 0, 0, 0.08);
    }

    .shop-icon {
      width: 40px;
      height: 40px;
      border-radius: 16px;
      background: radial-gradient(circle at 30% 10%, #ffffff 0, #ffd1a7 50%, #ffb370 100%);
      box-shadow: 0 8px 18px rgba(0, 0, 0, 0.18);
      position: relative;
      overflow: hidden;
    }

    /* –ø—Ä–æ—Å—Ç—ã–µ ‚Äú—Ä—É—á–Ω—ã–µ‚Äù —Å–ø—Ä–∞–π—Ç—ã –µ–¥—ã/–∏–≥—Ä—É—à–µ–∫ */
    .icon-fish,
    .icon-ball,
    .icon-cake {
      position: absolute;
      inset: 6px;
    }

    /* —Ä—ã–±–∞ */
    .icon-fish-body {
      position: absolute;
      left: 4px;
      top: 8px;
      width: 22px;
      height: 14px;
      border-radius: 20px;
      background: linear-gradient(90deg, #38bdf8, #0ea5e9);
    }

    .icon-fish-tail {
      position: absolute;
      right: 2px;
      top: 7px;
      width: 10px;
      height: 16px;
      background: linear-gradient(90deg, #0ea5e9, #0369a1);
      clip-path: polygon(0 50%, 100% 0, 100% 100%);
    }

    .icon-fish-eye {
      position: absolute;
      left: 8px;
      top: 11px;
      width: 3px;
      height: 3px;
      border-radius: 50%;
      background: #0f172a;
    }

    /* –º—è—á–∏–∫ */
    .icon-ball-disc {
      position: absolute;
      inset: 5px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 20%, #ffffff 0, #f97316 50%, #ea580c 100%);
    }

    .icon-ball-line {
      position: absolute;
      inset: 10px;
      border-radius: 50%;
      border: 2px solid rgba(255, 255, 255, 0.85);
    }

    /* —Ç–æ—Ä—Ç */
    .icon-cake-layer {
      position: absolute;
      left: 4px;
      right: 4px;
      bottom: 6px;
      height: 14px;
      border-radius: 4px;
      background: #fed7aa;
    }

    .icon-cake-top {
      position: absolute;
      left: 4px;
      right: 4px;
      bottom: 16px;
      height: 8px;
      border-radius: 6px 6px 2px 2px;
      background: #fb7185;
    }

    .icon-cake-candle {
      position: absolute;
      left: 50%;
      bottom: 24px;
      width: 3px;
      height: 8px;
      transform: translateX(-50%);
      background: #e5e7eb;
    }

    .icon-cake-flame {
      position: absolute;
      left: 50%;
      bottom: 32px;
      width: 5px;
      height: 7px;
      transform: translateX(-50%);
      border-radius: 50%;
      background: radial-gradient(circle at 30% 10%, #fef3c7 0, #f97316 80%);
    }

    .shop-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .shop-item-title {
      font-size: 14px;
      font-weight: 700;
      color: #374151;
    }

    .shop-item-desc {
      font-size: 12px;
      color: var(--text-soft);
    }

    .shop-meta {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 2px;
      font-size: 11px;
    }

    .shop-price-chip {
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.95);
      display: inline-flex;
      align-items: center;
      gap: 4px;
      color: var(--text-soft);
    }

    .shop-effect-chip {
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.8);
      color: #16a34a;
    }

    .shop-actions {
      display: flex;
      align-items: center;
    }

    .shop-btn {
      border-radius: 999px;
      padding: 6px 10px;
      border: none;
      outline: none;
      cursor: pointer;
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      color: #fff;
      font-size: 12px;
      font-weight: 600;
      box-shadow: 0 8px 18px rgba(255, 159, 107, 0.45);
    }

    .shop-btn:disabled {
      opacity: 0.55;
      box-shadow: none;
      cursor: default;
    }

    .shop-footer {
      display: flex;
      justify-content: flex-end;
      margin-top: 4px;
    }

    /* Level select (3-in-row) */
    .levels-grid {
      flex: 1;
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 8px;
      margin-top: 6px;
    }

    .level-card {
      border-radius: 16px;
      background: rgba(255, 255, 255, 0.96);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
      padding: 6px 4px 6px 4px;
      text-align: center;
      cursor: pointer;
      font-size: 11px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      align-items: center;
      justify-content: center;
    }

    .level-card .lvl-number {
      font-size: 14px;
      font-weight: 700;
      color: #374151;
    }

    .level-card .lvl-tag {
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 10px;
      background: rgba(248, 250, 252, 1);
      color: var(--text-soft);
    }

    .level-card.completed {
      border: 2px solid var(--accent-strong);
    }

    /* Match-3 board */
    .match3-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      font-size: 12px;
    }

    .match3-info-chip {
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.95);
      display: inline-flex;
      align-items: center;
      gap: 4px;
      color: var(--text-soft);
    }

    .match3-board-wrap {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 8px;
    }

    .match3-board {
      position: relative;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 18px;
      padding: 4px;
      box-shadow: 0 10px 26px rgba(0, 0, 0, 0.16);
      display: grid;
      touch-action: manipulation;
    }

    .cell {
      width: 32px;
      height: 32px;
      margin: 2px;
      border-radius: 10px;
      background: #e5e7eb;
      position: relative;
      overflow: hidden;
    }

    .cell.empty {
      background: transparent;
      box-shadow: none;
    }

    .tile {
      width: 100%;
      height: 100%;
      border-radius: 10px;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.16);
      position: relative;
      transform-origin: center;
      transition: transform 0.18s ease-out;
    }

    .tile.selected {
      transform: scale(1.08);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.28);
    }

    .tile.type-0 { background: radial-gradient(circle at 30% 20%, #fff7ed 0, #f97316 55%, #ea580c 100%); }
    .tile.type-1 { background: radial-gradient(circle at 30% 20%, #fef9c3 0, #facc15 55%, #eab308 100%); }
    .tile.type-2 { background: radial-gradient(circle at 30% 20%, #f0fdf4 0, #22c55e 55%, #16a34a 100%); }
    .tile.type-3 { background: radial-gradient(circle at 30% 20%, #eef2ff 0, #6366f1 55%, #4f46e5 100%); }
    .tile.type-4 { background: radial-gradient(circle at 30% 20%, #fee2e2 0, #fb7185 55%, #f43f5e 100%); }
    .tile.type-5 { background: radial-gradient(circle at 30% 20%, #f5f3ff 0, #a855f7 55%, #7e22ce 100%); }

    .tile-clearing {
      animation: tileClear 0.25s ease-out forwards;
    }

    .tile-new {
      animation: tileFall 0.3s ease-out;
    }

    @keyframes tileClear {
      0% { transform: scale(1); opacity: 1; }
      100% { transform: scale(0.4); opacity: 0; }
    }

    @keyframes tileFall {
      0% { transform: translateY(-20px); opacity: 0; }
      100% { transform: translateY(0); opacity: 1; }
    }

    .match3-footer {
      margin-top: 8px;
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }

    /* Overlay result */
    .overlay-center {
      position: absolute;
      inset: 0;
      display: none;
      justify-content: center;
      align-items: center;
      background: rgba(15, 23, 42, 0.35);
      z-index: 10;
    }

    .overlay-center.visible {
      display: flex;
    }

    .overlay-card {
      border-radius: 20px;
      background: #fff7ee;
      padding: 16px 14px;
      box-shadow: 0 16px 40px rgba(0, 0, 0, 0.4);
      text-align: center;
      max-width: 260px;
    }

    .overlay-card h3 {
      margin: 0 0 6px 0;
      font-size: 16px;
    }

    .overlay-card p {
      margin: 0 0 10px 0;
      font-size: 13px;
      color: var(--text-soft);
    }

    .text-soft {
      color: var(--text-soft);
    }

    @media (max-height: 650px) {
      .pet-stage {
        width: 190px;
      }
      .pet-main-sprite {
        width: 120px;
        height: 112px;
      }
      .cell {
        width: 28px;
        height: 28px;
      }
    }
  </style>
</head>
<body>
<div class="app">
  <!-- HEADER -->
  <header class="app-header">
    <div class="header-left">
      <button class="header-btn" id="btnBackRoot" style="display:none;">‚Üê</button>
      <div class="header-title" id="headerTitle">–î–æ–º–∏–∫ –ø–∏—Ç–æ–º—Ü–∞</div>
    </div>
    <div class="header-right">
      <div class="coin-circle">‚Çµ</div>
      <span id="coinBalance">0</span>
    </div>
  </header>

  <!-- SCREENS -->
  <main class="screens">
    <!-- 1. –í—ã–±–æ—Ä –ø–∏—Ç–æ–º—Ü–∞ -->
    <section class="screen active" id="screen-select-pet">
      <div class="card">
        <div class="card-inner">
          <div class="card-header">
            <div class="card-title">–í—ã–±–µ—Ä–∏ –ø–∏—Ç–æ–º—Ü–∞</div>
            <div class="card-subtitle">
              –í–∞—à –Ω–æ–≤—ã–π —Å–æ—Å–µ–¥ –ø–æ –¥–æ–º—É –≤ —Å—Ç–∏–ª–µ Homescapes —É–∂–µ –∂–¥—ë—Ç –≤–∞—Å.
            </div>
          </div>

          <div class="pet-select-grid">
            <!-- –ö–æ—à–∫–∞ -->
            <button class="pet-card" data-pet-type="cat" type="button">
              <div class="pet-sprite-preview">
                <div class="pet-sprite-head">
                  <div class="pet-sprite-ear left"></div>
                  <div class="pet-sprite-ear right"></div>
                  <div class="pet-sprite-face">
                    <div class="pet-eye left"></div>
                    <div class="pet-eye right"></div>
                    <div class="pet-blush left"></div>
                    <div class="pet-blush right"></div>
                    <div class="pet-mouth"></div>
                  </div>
                </div>
              </div>
              <div class="pet-body-tag">–ö–æ—à–∫–∞</div>
              <div class="pet-body-sub">–ü—É—à–∏—Å—Ç—ã–π –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—å</div>
            </button>

            <!-- –°–æ–±–∞–∫–∞ -->
            <button class="pet-card" data-pet-type="dog" type="button">
              <div class="pet-sprite-preview">
                <div class="pet-sprite-head" style="border-radius:40px 40px 36px 36px;
                background: radial-gradient(circle at 30% 10%, #fff3d3 0, #facc8f 60%, #f59e0b 100%);">
                  <div class="pet-sprite-ear left" style="height:24px;background:linear-gradient(135deg,#fbbf24,#f97316)"></div>
                  <div class="pet-sprite-ear right" style="height:24px;background:linear-gradient(135deg,#fbbf24,#f97316)"></div>
                  <div class="pet-sprite-face">
                    <div class="pet-eye left"></div>
                    <div class="pet-eye right"></div>
                    <div class="pet-blush left"></div>
                    <div class="pet-blush right"></div>
                    <div class="pet-mouth"></div>
                  </div>
                </div>
              </div>
              <div class="pet-body-tag">–°–æ–±–∞–∫–∞</div>
              <div class="pet-body-sub">–í–µ—Ä–Ω—ã–π –æ–∑–æ—Ä–Ω–∏–∫</div>
            </button>

            <!-- –•–æ–º—è–∫ -->
            <button class="pet-card" data-pet-type="hamster" type="button">
              <div class="pet-sprite-preview">
                <div class="pet-sprite-head" style="width:58px;height:50px;border-radius:38px;
                background: radial-gradient(circle at 30% 10%, #fffbeb 0, #fed7aa 55%, #f97316 100%);">
                  <div class="pet-sprite-face">
                    <div class="pet-eye left"></div>
                    <div class="pet-eye right"></div>
                    <div class="pet-blush left"></div>
                    <div class="pet-blush right"></div>
                    <div class="pet-mouth"></div>
                  </div>
                </div>
              </div>
              <div class="pet-body-tag">–•–æ–º—è–∫</div>
              <div class="pet-body-sub">–ö–∞—Ä–º–∞–Ω–Ω—ã–π —Å–ª–∞–¥–∫–æ–µ–∂–∫–∞</div>
            </button>
          </div>

          <div class="text-soft" style="font-size:12px;margin-top:4px;">
            –í—ã–±–æ—Ä –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å, –Ω–∞—á–∞–≤ –∏–≥—Ä—É –∑–∞–Ω–æ–≤–æ. –ü—Ä–æ–≥—Ä–µ—Å—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è.
          </div>

          <button class="btn-primary" id="btn-select-pet-next" disabled>
            –î–∞–ª–µ–µ
          </button>
        </div>
      </div>
    </section>

    <!-- 2. –ò–º—è –ø–∏—Ç–æ–º—Ü–∞ -->
    <section class="screen" id="screen-pet-name">
      <div class="card">
        <div class="card-inner">
          <div class="card-header">
            <div class="card-title">–ò–º—è –¥–ª—è –ª—é–±–∏–º—Ü–∞</div>
            <div class="card-subtitle" id="pet-name-subtitle">
              –ü—Ä–∏–¥—É–º–∞–π—Ç–µ —Ç—ë–ø–ª–æ–µ –∏–º—è –¥–ª—è –≤–∞—à–µ–≥–æ –Ω–æ–≤–æ–≥–æ –¥—Ä—É–≥–∞.
            </div>
          </div>

          <div class="form-group">
            <label for="petNameInput" class="form-label">–ö–∞–∫ –º—ã –±—É–¥–µ–º –µ–≥–æ –∑–≤–∞—Ç—å?</label>
            <input id="petNameInput"
                   class="form-input"
                   type="text"
                   maxlength="18"
                   placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü—É—à–æ–∫ –∏–ª–∏ –ë–æ–Ω—è" />
          </div>

          <div class="text-soft" style="font-size:12px;margin-top:4px;">
            –ü–∏—Ç–æ–º–µ—Ü –±—É–¥–µ—Ç –æ—Ç–∫–ª–∏–∫–∞—Ç—å—Å—è –Ω–∞ —ç—Ç–æ –∏–º—è –∏ —Ä–∞–¥–æ–≤–∞—Ç—å—Å—è, –∫–æ–≥–¥–∞ –≤—ã –∑–∞—Ö–æ–¥–∏—Ç–µ –∫ –Ω–µ–º—É –≤ –¥–æ–º–∏–∫.
          </div>

          <button class="btn-primary" id="btn-create-pet">
            –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å
          </button>
        </div>
      </div>
    </section>

    <!-- 3. –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω –ø–∏—Ç–æ–º—Ü–∞ -->
    <section class="screen" id="screen-pet-main">
      <div class="card">
        <div class="card-inner">
          <div class="pet-main-header">
            <div class="pet-mood-indicator" id="moodBadge">
              <span id="moodBadgeIcon">üôÇ</span>
              <span id="moodBadgeText">–°–ø–æ–∫–æ–π–Ω–æ</span>
            </div>
            <div class="pet-name-chip">
              <span id="petNameDisplay">–ü–∏—Ç–æ–º–µ—Ü</span>
            </div>
            <button class="btn-secondary" id="btn-open-shop">–ú–∞–≥–∞–∑–∏–Ω</button>
          </div>

          <div class="pet-main-layout">
            <div class="pet-stage-wrap">
              <div class="pet-stage" id="petStage">
                <div class="pet-stage-floor"></div>
                <div class="pet-main-sprite pet-main-idle" id="petSpriteMain">
                  <div class="pet-main-body" id="petBodyMain"></div>
                  <div class="pet-main-head">
                    <div class="pet-main-ears">
                      <div class="pet-main-ear left"></div>
                      <div class="pet-main-ear right"></div>
                    </div>
                    <div class="pet-main-face">
                      <div class="pet-main-eye left"></div>
                      <div class="pet-main-eye right"></div>
                      <div class="pet-main-blush left"></div>
                      <div class="pet-main-blush right"></div>
                      <div class="pet-main-mouth" id="petMouthMain"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="stats-panel">
              <div class="stat-row">
                <div class="stat-icon">üçó</div>
                <div class="stat-content">
                  <div class="stat-label-row">
                    <span>–°—ã—Ç–æ—Å—Ç—å</span>
                    <span><strong id="hungerText">100 / 100</strong></span>
                  </div>
                  <div class="stat-bar">
                    <div class="stat-bar-fill" id="hungerBar"></div>
                  </div>
                </div>
              </div>
              <div class="stat-row">
                <div class="stat-icon">üéà</div>
                <div class="stat-content">
                  <div class="stat-label-row">
                    <span>–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ</span>
                    <span><strong id="moodText">100 / 100</strong></span>
                  </div>
                  <div class="stat-bar">
                    <div class="stat-bar-fill mood" id="moodBar"></div>
                  </div>
                </div>
              </div>

              <div class="text-soft" style="font-size:11px;margin-top:2px;">
                –ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏ —Å–Ω–∏–∂–∞—é—Ç—Å—è –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç. –ö–æ—Ä–º–∏—Ç–µ –∏ –∏–≥—Ä–∞–π—Ç–µ —Å –ø–∏—Ç–æ–º—Ü–µ–º, —á—Ç–æ–±—ã –æ–Ω –æ—Å—Ç–∞–≤–∞–ª—Å—è —Å—á–∞—Å—Ç–ª–∏–≤—ã–º.
              </div>
            </div>

            <div class="pet-bottom-bar">
              <button class="btn-primary" id="btn-play-match3">
                –ò–≥—Ä–∞—Ç—å –≤ ‚Äú3 –≤ —Ä—è–¥‚Äù
              </button>
              <button class="btn-secondary" id="btn-open-shop-bottom">
                –ú–∞–≥–∞–∑–∏–Ω
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- 4. –≠–∫—Ä–∞–Ω –≤—ã–±–æ—Ä–∞ —É—Ä–æ–≤–Ω—è -->
    <section class="screen" id="screen-level-select">
      <div class="card">
        <div class="card-inner">
          <div class="card-header">
            <div class="card-title">–£—Ä–æ–≤–Ω–∏ ‚Äú3 –≤ —Ä—è–¥‚Äù</div>
            <div class="card-subtitle">
              –ü—Ä–æ—Ö–æ–¥–∏—Ç–µ —É—Ä–æ–≤–Ω–∏ —Å —Ä–∞–∑–Ω–æ–π –≥–µ–æ–º–µ—Ç—Ä–∏–µ–π –ø–æ–ª—è –∏ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ –º–æ–Ω–µ—Ç—ã.
            </div>
          </div>

          <div class="levels-grid" id="levelsGrid"></div>

          <div class="text-soft" style="font-size:11px;margin-top:4px;">
            –ó–∞ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è –≤—ã –ø–æ–ª—É—á–∞–µ—Ç–µ <strong>10 –º–æ–Ω–µ—Ç</strong>. –ü–æ–ø—ã—Ç–æ–∫ –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ.
          </div>

          <button class="btn-secondary" id="btn-back-to-pet-from-levels">
            –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –ø–∏—Ç–æ–º—Ü—É
          </button>
        </div>
      </div>
    </section>

    <!-- 5. –≠–∫—Ä–∞–Ω –∏–≥—Ä—ã ‚Äú3 –≤ —Ä—è–¥‚Äù -->
    <section class="screen" id="screen-match3">
      <div class="card">
        <div class="card-inner">
          <div class="match3-top">
            <div class="match3-info-chip">
              –£—Ä–æ–≤–µ–Ω—å <span id="matchLevelNumber">1</span>
            </div>
            <div class="match3-info-chip">
              –•–æ–¥—ã: <span id="movesLeft">20</span>
            </div>
            <div class="match3-info-chip">
              –û—á–∫–∏: <span id="scoreCurrent">0</span> / <span id="scoreTarget">1000</span>
            </div>
          </div>

          <div class="match3-board-wrap">
            <div class="match3-board" id="matchBoard"></div>
          </div>

          <div class="match3-footer">
            <button class="btn-secondary" id="btn-exit-match3">
              –ó–∞–≤–µ—Ä—à–∏—Ç—å
            </button>
            <button class="btn-secondary" id="btn-match3-hint">
              –ü–æ–¥—Å–∫–∞–∑–∫–∞
            </button>
          </div>

          <!-- –û–≤–µ—Ä–ª–µ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ -->
          <div class="overlay-center" id="match3ResultOverlay">
            <div class="overlay-card">
              <h3 id="match3ResultTitle">–£—Ä–æ–≤–µ–Ω—å –ø—Ä–æ–π–¥–µ–Ω!</h3>
              <p id="match3ResultText">
                –ü–∏—Ç–æ–º–µ—Ü –±—É–¥–µ—Ç —Ä–∞–¥ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º –º–æ–Ω–µ—Ç–∫–∞–º –∑–∞ –≤–∞—à—É –ø–æ–±–µ–¥—É.
              </p>
              <button class="btn-primary" id="btn-match3-result-ok">
                –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- SHOP OVERLAY -->
  <div class="shop-overlay" id="shopOverlay">
    <div class="shop-panel">
      <div class="shop-header">
        <div class="shop-tabs">
          <button class="shop-tab active" data-shop-tab="food">–ï–¥–∞</button>
          <button class="shop-tab" data-shop-tab="toys">–ò–≥—Ä—É—à–∫–∏</button>
        </div>
        <div class="shop-balance">
          <span>–ë–∞–ª–∞–Ω—Å:</span>
          <div class="coin-circle" style="width:16px;height:16px;font-size:10px;">‚Çµ</div>
          <span id="shopBalance">0</span>
        </div>
      </div>

      <div class="shop-items" id="shopItems"></div>

      <div class="shop-footer">
        <button class="btn-secondary" id="btn-close-shop">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  </div>
</div>

<script>
(function () {
  const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
  if (tg) {
    try {
      tg.ready();
      tg.expand();
      if (tg.setBackgroundColor) tg.setBackgroundColor("#f9f3ef");
    } catch (e) { console.warn("TWA init error", e); }
  }

  const STORAGE_KEY = "homescapes_pet_match3_state_v1";

  const screens = {
    selectPet: document.getElementById("screen-select-pet"),
    petName: document.getElementById("screen-pet-name"),
    petMain: document.getElementById("screen-pet-main"),
    levels: document.getElementById("screen-level-select"),
    match3: document.getElementById("screen-match3"),
  };

  const headerTitle = document.getElementById("headerTitle");
  const btnBackRoot = document.getElementById("btnBackRoot");
  const coinBalanceEl = document.getElementById("coinBalance");

  const shopOverlay = document.getElementById("shopOverlay");
  const shopTabs = document.querySelectorAll(".shop-tab");
  const shopItemsContainer = document.getElementById("shopItems");
  const shopBalanceEl = document.getElementById("shopBalance");
  const btnCloseShop = document.getElementById("btn-close-shop");

  const petCardEls = document.querySelectorAll(".pet-card");
  const btnSelectPetNext = document.getElementById("btn-select-pet-next");
  const petNameInput = document.getElementById("petNameInput");
  const btnCreatePet = document.getElementById("btn-create-pet");
  const petNameSubtitle = document.getElementById("pet-name-subtitle");

  const petNameDisplay = document.getElementById("petNameDisplay");
  const hungerText = document.getElementById("hungerText");
  const hungerBar = document.getElementById("hungerBar");
  const moodText = document.getElementById("moodText");
  const moodBar = document.getElementById("moodBar");
  const moodBadge = document.getElementById("moodBadge");
  const moodBadgeIcon = document.getElementById("moodBadgeIcon");
  const moodBadgeText = document.getElementById("moodBadgeText");

  const petSpriteMain = document.getElementById("petSpriteMain");
  const petBodyMain = document.getElementById("petBodyMain");
  const petMouthMain = document.getElementById("petMouthMain");

  const btnPlayMatch3 = document.getElementById("btn-play-match3");
  const btnOpenShopTop = document.getElementById("btn-open-shop");
  const btnOpenShopBottom = document.getElementById("btn-open-shop-bottom");
  const btnBackToPetFromLevels = document.getElementById("btn-back-to-pet-from-levels");

  const levelsGrid = document.getElementById("levelsGrid");

  const matchBoardEl = document.getElementById("matchBoard");
  const matchLevelNumberEl = document.getElementById("matchLevelNumber");
  const movesLeftEl = document.getElementById("movesLeft");
  const scoreCurrentEl = document.getElementById("scoreCurrent");
  const scoreTargetEl = document.getElementById("scoreTarget");
  const btnExitMatch3 = document.getElementById("btn-exit-match3");
  const btnMatch3Hint = document.getElementById("btn-match3-hint");
  const match3ResultOverlay = document.getElementById("match3ResultOverlay");
  const match3ResultTitle = document.getElementById("match3ResultTitle");
  const match3ResultText = document.getElementById("match3ResultText");
  const btnMatch3ResultOk = document.getElementById("btn-match3-result-ok");

  const defaultState = {
    petType: null,
    petName: "",
    coins: 0,
    hunger: 100,
    mood: 100,
    lastDecay: Date.now(),
    itemsPurchased: {
      fish: 0,
      ball: 0,
      cake: 0
    },
    levelsCompleted: {},
  };

  let state = { ...defaultState };
  let currentScreenKey = "selectPet";
  let energyTimer = null;

  // Match-3 runtime
  let currentLevel = null;
  let currentBoard = [];
  let currentMask = [];
  let boardRows = 0;
  let boardCols = 0;
  let matchSelected = null;
  let isProcessing = false;
  let movesLeft = 0;
  let score = 0;

  const shopData = {
    food: [
      { id: "fish", title: "–†—ã–±–∫–∞", cost: 20, hunger: +30, mood: +10,
        desc: "–°–æ—á–Ω–∞—è —Ä—ã–±–∫–∞ –¥–ª—è –≥—É—Ä–º–∞–Ω–æ–≤. –°–∏–ª—å–Ω–æ –ø–æ–≤—ã—à–∞–µ—Ç —Å—ã—Ç–æ—Å—Ç—å –∏ –Ω–µ–º–Ω–æ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ." },
      { id: "cake", title: "–ü—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–π —Ç–æ—Ä—Ç", cost: 50, hunger: +50, mood: +30,
        desc: "–¶–µ–ª—ã–π —Ç–æ—Ä—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–∏—Ç–æ–º—Ü–∞. –ú–Ω–æ–≥–æ —Å—ã—Ç–æ—Å—Ç–∏ –∏ —Ä–∞–¥–æ—Å—Ç–∏ —Å—Ä–∞–∑—É." }
    ],
    toys: [
      { id: "ball", title: "–ú—è—á–∏–∫", cost: 15, hunger: 0, mood: +25,
        desc: "–ü—É—à–∏—Å—Ç—ã–π –º—è—á–∏–∫ –¥–ª—è –∏–≥—Ä –≤ –∫–æ–º–Ω–∞—Ç–µ. –°–∏–ª—å–Ω–æ —É–ª—É—á—à–∞–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ." }
    ]
  };

  const LEVEL_DEFS = [
    // 1: –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–µ 7x9
    {
      id: 1,
      rows: 7,
      cols: 9,
      description: "–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–µ –ø–æ–ª–µ 7√ó9",
      moves: 20,
      targetScore: 800,
      mask: null
    },
    // 2: —Ç—Ä–µ—É–≥–æ–ª—å–Ω–æ–µ –ø–æ–ª–µ
    {
      id: 2,
      rows: 7,
      cols: 7,
      description: "–¢—Ä–µ—É–≥–æ–ª—å–Ω–æ–µ –ø–æ–ª–µ",
      moves: 18,
      targetScore: 900,
      mask: "triangle"
    },
    // 3: 5x9 —Å ‚Äú–ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è–º–∏‚Äù (–¥—ã—Ä—ã)
    {
      id: 3,
      rows: 5,
      cols: 9,
      description: "–ü–æ–ª–µ —Å –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è–º–∏",
      moves: 18,
      targetScore: 900,
      mask: "holes"
    },
    // 4: —Å–µ—Ä–¥—Ü–µ
    {
      id: 4,
      rows: 9,
      cols: 9,
      description: "–ü–æ–ª–µ –≤ —Ñ–æ—Ä–º–µ —Å–µ—Ä–¥—Ü–∞",
      moves: 22,
      targetScore: 1000,
      mask: "heart"
    },
    // 5: 8x8 —Å –ø—É—Å—Ç—ã–º–∏ –±–ª–æ–∫–∞–º–∏
    {
      id: 5,
      rows: 8,
      cols: 8,
      description: "–ü–æ–ª–µ —Å –ø—É—Å—Ç—ã–º–∏ –±–ª–æ–∫–∞–º–∏",
      moves: 20,
      targetScore: 950,
      mask: "holes2"
    },
    // –æ—Å—Ç–∞–ª—å–Ω—ã–µ —É—Ä–æ–≤–Ω–∏ ‚Äî –ø—Ä–æ—Å—Ç—ã–µ –∫–≤–∞–¥—Ä–∞—Ç—ã
    { id: 6, rows: 7, cols: 7, description: "–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π", moves: 18, targetScore: 900, mask: null },
    { id: 7, rows: 8, cols: 7, description: "–ß—É—Ç—å —à–∏—Ä–µ", moves: 20, targetScore: 1000, mask: null },
    { id: 8, rows: 6, cols: 8, description: "–ö–æ–º–ø–∞–∫—Ç–Ω—ã–π", moves: 16, targetScore: 850, mask: null },
    { id: 9, rows: 7, cols: 8, description: "–°—Ç—É–ø–µ–Ω—å–∫–∏", moves: 18, targetScore: 950, mask: "stairs" },
    { id: 10, rows: 8, cols: 8, description: "–ü–ª–æ—Ç–Ω–æ–µ –ø–æ–ª–µ", moves: 22, targetScore: 1100, mask: null }
  ];

  function saveState() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    } catch (e) {
      console.warn("saveState error", e);
    }
  }

  function loadState() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      const parsed = JSON.parse(raw);
      state = {
        ...defaultState,
        ...parsed,
        itemsPurchased: {
          ...defaultState.itemsPurchased,
          ...(parsed.itemsPurchased || {})
        },
        levelsCompleted: parsed.levelsCompleted || {}
      };
    } catch (e) {
      console.warn("loadState error", e);
    }
  }

  function switchScreen(key) {
    currentScreenKey = key;
    Object.entries(screens).forEach(([k, el]) => {
      if (k === key) el.classList.add("active");
      else el.classList.remove("active");
    });

    let title = "–î–æ–º–∏–∫ –ø–∏—Ç–æ–º—Ü–∞";
    if (key === "selectPet") title = "–í—ã–±–æ—Ä –ø–∏—Ç–æ–º—Ü–∞";
    else if (key === "petName") title = "–ò–º—è –ø–∏—Ç–æ–º—Ü–∞";
    else if (key === "petMain") title = "–î–æ–º–∏–∫ –ø–∏—Ç–æ–º—Ü–∞";
    else if (key === "levels") title = "–£—Ä–æ–≤–Ω–∏ 3 –≤ —Ä—è–¥";
    else if (key === "match3") title = "–ò–≥—Ä–∞ 3 –≤ —Ä—è–¥";
    headerTitle.textContent = title;

    if (key === "petMain" || key === "selectPet" || key === "petName") {
      btnBackRoot.style.display = "none";
    } else {
      btnBackRoot.style.display = "inline-flex";
    }
  }

  function showAlert(msg) {
    if (tg && tg.showAlert) tg.showAlert(msg);
    else alert(msg);
  }

  function updateCoinsUI() {
    coinBalanceEl.textContent = state.coins.toString();
    shopBalanceEl.textContent = state.coins.toString();
  }

  function clamp(val, min = 0, max = 100) {
    return Math.max(min, Math.min(max, val));
  }

  function applyDecayIfNeeded() {
    const now = Date.now();
    const diffMs = now - (state.lastDecay || now);
    const minutes = Math.floor(diffMs / 60000);
    if (minutes <= 0) return;

    const steps = Math.floor(minutes / 30);
    if (steps <= 0) return;

    const decayHunger = 5 * steps;
    const decayMood = 5 * steps;

    state.hunger = clamp(state.hunger - decayHunger);
    state.mood = clamp(state.mood - decayMood);
    state.lastDecay = now;
    saveState();
  }

  function startDecayTimer() {
    if (energyTimer) clearInterval(energyTimer);
    energyTimer = setInterval(() => {
      const now = Date.now();
      const diffMs = now - (state.lastDecay || now);
      const minutes = Math.floor(diffMs / 60000);
      if (minutes >= 30) {
        applyDecayIfNeeded();
        updatePetUI();
      }
    }, 60000);
  }

  function updatePetMoodVisual() {
    const hunger = state.hunger;
    const mood = state.mood;
    const avg = (hunger + mood) / 2;

    petBodyMain.classList.remove("pet-main-sad-tone", "pet-main-happy-tone");
    petMouthMain.classList.remove("happy", "sad");

    if (avg >= 70) {
      petBodyMain.classList.add("pet-main-happy-tone");
      petMouthMain.classList.add("happy");
      moodBadgeIcon.textContent = "üòä";
      moodBadgeText.textContent = "–û—á–µ–Ω—å —Ä–∞–¥";
    } else if (avg >= 40) {
      moodBadgeIcon.textContent = "üôÇ";
      moodBadgeText.textContent = "–°–ø–æ–∫–æ–π–Ω–æ";
    } else {
      petBodyMain.classList.add("pet-main-sad-tone");
      petMouthMain.classList.add("sad");
      moodBadgeIcon.textContent = "‚òπÔ∏è";
      moodBadgeText.textContent = "–ì—Ä—É—Å—Ç–∏—Ç";
    }
  }

  function updatePetUI() {
    petNameDisplay.textContent = state.petName || "–ü–∏—Ç–æ–º–µ—Ü";

    const h = clamp(state.hunger);
    const m = clamp(state.mood);
    hungerText.textContent = `${h} / 100`;
    moodText.textContent = `${m} / 100`;
    hungerBar.style.width = `${h}%`;
    moodBar.style.width = `${m}%`;

    updatePetMoodVisual();
    updateCoinsUI();
  }

  function animatePetHappy() {
    petSpriteMain.classList.remove("pet-main-happy-anim");
    void petSpriteMain.offsetWidth;
    petSpriteMain.classList.add("pet-main-happy-anim");
  }

  function adjustStats(deltaHunger, deltaMood) {
    state.hunger = clamp(state.hunger + deltaHunger);
    state.mood = clamp(state.mood + deltaMood);
    state.lastDecay = Date.now();
    saveState();
    updatePetUI();
    animatePetHappy();
  }

  function renderShop(tabKey) {
    shopItemsContainer.innerHTML = "";
    const list = shopData[tabKey] || [];

    list.forEach(item => {
      const div = document.createElement("div");
      div.className = "shop-item";
      div.dataset.itemId = item.id;

      const icon = document.createElement("div");
      icon.className = "shop-icon";
      if (item.id === "fish") {
        const g = document.createElement("div");
        g.className = "icon-fish";
        g.innerHTML =
          '<div class="icon-fish-body"></div>' +
          '<div class="icon-fish-tail"></div>' +
          '<div class="icon-fish-eye"></div>';
        icon.appendChild(g);
      } else if (item.id === "ball") {
        const g = document.createElement("div");
        g.className = "icon-ball";
        g.innerHTML =
          '<div class="icon-ball-disc"></div>' +
          '<div class="icon-ball-line"></div>';
        icon.appendChild(g);
      } else if (item.id === "cake") {
        const g = document.createElement("div");
        g.className = "icon-cake";
        g.innerHTML =
          '<div class="icon-cake-layer"></div>' +
          '<div class="icon-cake-top"></div>' +
          '<div class="icon-cake-candle"></div>' +
          '<div class="icon-cake-flame"></div>';
        icon.appendChild(g);
      }

      const content = document.createElement("div");
      content.className = "shop-content";
      const title = document.createElement("div");
      title.className = "shop-item-title";
      title.textContent = item.title;
      const desc = document.createElement("div");
      desc.className = "shop-item-desc";
      desc.textContent = item.desc;

      const meta = document.createElement("div");
      meta.className = "shop-meta";
      const priceChip = document.createElement("div");
      priceChip.className = "shop-price-chip";
      priceChip.innerHTML = `<span>‚Çµ${item.cost}</span>`;
      const effectChip = document.createElement("div");
      effectChip.className = "shop-effect-chip";
      const h = item.hunger > 0 ? `–°—ã—Ç–æ—Å—Ç—å +${item.hunger}` : "";
      const m = item.mood > 0 ? `–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ +${item.mood}` : "";
      effectChip.textContent = `${h}${h && m ? ", " : ""}${m}`;
      meta.appendChild(priceChip);
      meta.appendChild(effectChip);

      content.appendChild(title);
      content.appendChild(desc);
      content.appendChild(meta);

      const actions = document.createElement("div");
      actions.className = "shop-actions";
      const btn = document.createElement("button");
      btn.className = "shop-btn";
      btn.textContent = "–ö—É–ø–∏—Ç—å";
      if (state.coins < item.cost) btn.disabled = true;
      btn.addEventListener("click", () => {
        if (state.coins < item.cost) {
          showAlert("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –º–æ–Ω–µ—Ç!");
          return;
        }
        state.coins -= item.cost;
        state.itemsPurchased[item.id] = (state.itemsPurchased[item.id] || 0) + 1;
        adjustStats(item.hunger, item.mood);
        saveState();
        updateCoinsUI();
        renderShop(tabKey);
      });
      actions.appendChild(btn);

      div.appendChild(icon);
      div.appendChild(content);
      div.appendChild(actions);
      shopItemsContainer.appendChild(div);
    });
  }

  function openShop(initialTab = "food") {
    shopOverlay.classList.add("visible");
    shopTabs.forEach(tab => {
      tab.classList.toggle("active", tab.dataset.shopTab === initialTab);
    });
    renderShop(initialTab);
  }

  function closeShop() {
    shopOverlay.classList.remove("visible");
  }

  function initLevelsGrid() {
    levelsGrid.innerHTML = "";
    LEVEL_DEFS.forEach(level => {
      const div = document.createElement("div");
      div.className = "level-card";
      if (state.levelsCompleted[level.id]) div.classList.add("completed");
      div.dataset.levelId = level.id;
      div.innerHTML = `
        <div class="lvl-number">${level.id}</div>
        <div class="lvl-tag">${level.description}</div>
      `;
      div.addEventListener("click", () => {
        startLevel(level.id);
      });
      levelsGrid.appendChild(div);
    });
  }

  // MASKS for levels
  function createMask(def) {
    const { rows, cols, mask } = def;
    const grid = [];
    for (let r = 0; r < rows; r++) {
      grid[r] = [];
      for (let c = 0; c < cols; c++) {
        grid[r][c] = true;
      }
    }
    if (!mask) return grid;

    if (mask === "triangle") {
      for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
          if (c > r) grid[r][c] = false;
        }
      }
    } else if (mask === "holes") {
      // –Ω–µ—Å–∫–æ–ª—å–∫–æ –¥—ã—Ä
      const holes = [
        [1, 2], [1, 6],
        [3, 1], [3, 7]
      ];
      holes.forEach(([r, c]) => {
        if (r < rows && c < cols) grid[r][c] = false;
      });
    } else if (mask === "holes2") {
      const holes = [
        [2, 2], [2, 5],
        [5, 2], [5, 5]
      ];
      holes.forEach(([r, c]) => {
        if (r < rows && c < cols) grid[r][c] = false;
      });
    } else if (mask === "heart") {
      for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
          grid[r][c] = false;
        }
      }
      const center = Math.floor(cols / 2);
      for (let r = 0; r < rows; r++) {
        const width = [0, 3, 5, 7, 9, 7, 5, 3, 1][r] || 0;
        const start = center - Math.floor(width / 2);
        for (let i = 0; i < width; i++) {
          const c = start + i;
          if (c >= 0 && c < cols) grid[r][c] = true;
        }
      }
    } else if (mask === "stairs") {
      for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
          if (c < r - 1) grid[r][c] = false;
        }
      }
    }

    return grid;
  }

  function showMatch3Result(win) {
    match3ResultTitle.textContent = win ? "–£—Ä–æ–≤–µ–Ω—å –ø—Ä–æ–π–¥–µ–Ω!" : "–•–æ–¥—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å";
    match3ResultText.textContent = win
      ? "–í—ã –ø–æ–ª—É—á–∞–µ—Ç–µ 10 –º–æ–Ω–µ—Ç. –ü–∏—Ç–æ–º–µ—Ü —Ä–∞–¥ –≤–∞—à–µ–π –ø–æ–±–µ–¥–µ!"
      : "–¶–µ–ª—å –Ω–µ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞, –Ω–æ –≤—ã –º–æ–∂–µ—Ç–µ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –µ—â—ë —Ä–∞–∑.";
    match3ResultOverlay.classList.add("visible");
  }

  function exitMatch3() {
    match3ResultOverlay.classList.remove("visible");
    switchScreen("levels");
    initLevelsGrid();
  }

  function startLevel(levelId) {
    const def = LEVEL_DEFS.find(l => l.id === levelId);
    if (!def) return;

    currentLevel = def;
    boardRows = def.rows;
    boardCols = def.cols;
    currentMask = createMask(def);
    currentBoard = [];
    matchSelected = null;
    isProcessing = false;
    movesLeft = def.moves;
    score = 0;

    matchLevelNumberEl.textContent = def.id.toString();
    movesLeftEl.textContent = movesLeft.toString();
    scoreCurrentEl.textContent = "0";
    scoreTargetEl.textContent = def.targetScore.toString();
    match3ResultOverlay.classList.remove("visible");

    matchBoardEl.style.gridTemplateRows = `repeat(${boardRows}, 1fr)`;
    matchBoardEl.style.gridTemplateColumns = `repeat(${boardCols}, 1fr)`;
    buildBoardInitial();

    switchScreen("match3");
  }

  function randomTileType() {
    return Math.floor(Math.random() * 6);
  }

  function buildBoardInitial() {
    currentBoard = [];
    matchBoardEl.innerHTML = "";

    for (let r = 0; r < boardRows; r++) {
      currentBoard[r] = [];
      for (let c = 0; c < boardCols; c++) {
        const playable = currentMask[r][c];
        const cell = document.createElement("div");
        cell.className = "cell" + (playable ? "" : " empty");
        cell.dataset.row = r;
        cell.dataset.col = c;
        matchBoardEl.appendChild(cell);

        if (!playable) {
          currentBoard[r][c] = null;
          continue;
        }

        let type;
        do {
          type = randomTileType();
          currentBoard[r][c] = { type };
        } while (createsMatch(r, c));

        const tile = createTileElement(type, r, c);
        cell.appendChild(tile);
      }
    }
  }

  function createTileElement(type, row, col) {
    const tile = document.createElement("div");
    tile.className = "tile tile-new type-" + type;
    tile.dataset.row = row;
    tile.dataset.col = col;

    tile.addEventListener("click", () => {
      handleTileClick(row, col);
    });
    return tile;
  }

  function getCell(row, col) {
    if (row < 0 || row >= boardRows || col < 0 || col >= boardCols) return null;
    return currentBoard[row][col];
  }

  function createsMatch(row, col) {
    const cell = getCell(row, col);
    if (!cell) return false;
    const type = cell.type;

    let count = 1;
    let c = col - 1;
    while (c >= 0 && getCell(row, c) && getCell(row, c).type === type) {
      count++; c--;
    }
    c = col + 1;
    while (c < boardCols && getCell(row, c) && getCell(row, c).type === type) {
      count++; c++;
    }
    if (count >= 3) return true;

    count = 1;
    let r = row - 1;
    while (r >= 0 && getCell(r, col) && getCell(r, col).type === type) {
      count++; r--;
    }
    r = row + 1;
    while (r < boardRows && getCell(r, col) && getCell(r, col).type === type) {
      count++; r++;
    }
    return count >= 3;
  }

  function handleTileClick(row, col) {
    if (isProcessing) return;
    if (!currentMask[row][col]) return;

    const cell = getCell(row, col);
    if (!cell) return;

    if (!matchSelected) {
      matchSelected = { row, col };
      highlightSelection();
      return;
    }

    if (matchSelected.row === row && matchSelected.col === col) {
      matchSelected = null;
      highlightSelection();
      return;
    }

    const isAdj =
      (Math.abs(matchSelected.row - row) === 1 && matchSelected.col === col) ||
      (Math.abs(matchSelected.col - col) === 1 && matchSelected.row === row);

    if (!isAdj) {
      matchSelected = { row, col };
      highlightSelection();
      return;
    }

    isProcessing = true;
    swapTiles(matchSelected, { row, col });
  }

  function highlightSelection() {
    const tiles = matchBoardEl.querySelectorAll(".tile");
    tiles.forEach(t => t.classList.remove("selected"));
    if (!matchSelected) return;
    const sel = matchBoardEl.querySelector(
      `.tile[data-row="${matchSelected.row}"][data-col="${matchSelected.col}"]`
    );
    if (sel) sel.classList.add("selected");
  }

  function swapTiles(a, b, revertIfNoMatch = true) {
    const tmp = currentBoard[a.row][a.col];
    currentBoard[a.row][a.col] = currentBoard[b.row][b.col];
    currentBoard[b.row][b.col] = tmp;

    const tileA = matchBoardEl.querySelector(`.tile[data-row="${a.row}"][data-col="${a.col}"]`);
    const tileB = matchBoardEl.querySelector(`.tile[data-row="${b.row}"][data-col="${b.col}"]`);

    if (tileA) {
      tileA.dataset.row = b.row;
      tileA.dataset.col = b.col;
    }
    if (tileB) {
      tileB.dataset.row = a.row;
      tileB.dataset.col = a.col;
    }

    const cellA = matchBoardEl.querySelector(`.cell[data-row="${a.row}"][data-col="${a.col}"]`);
    const cellB = matchBoardEl.querySelector(`.cell[data-row="${b.row}"][data-col="${b.col}"]`);

    if (cellA && cellB && tileA && tileB) {
      cellA.appendChild(tileB);
      cellB.appendChild(tileA);
    }

    highlightSelection();
    const matches = findMatches();

    if (matches.length === 0 && revertIfNoMatch) {
      setTimeout(() => {
        swapTiles(b, a, false);
        matchSelected = null;
        highlightSelection();
        isProcessing = false;
      }, 150);
      return;
    }

    if (revertIfNoMatch) {
      movesLeft--;
      movesLeftEl.textContent = movesLeft.toString();
    }

    if (matches.length > 0) {
      handleMatches(matches);
    } else {
      isProcessing = false;
    }
  }

  function findMatches() {
    const toClear = [];

    for (let r = 0; r < boardRows; r++) {
      let runType = null;
      let runStart = 0;
      for (let c = 0; c <= boardCols; c++) {
        const cell = c < boardCols ? getCell(r, c) : null;
        const type = cell ? cell.type : null;
        if (type === runType && type != null) {
          continue;
        } else {
          if (runType != null && c - runStart >= 3) {
            for (let cc = runStart; cc < c; cc++) {
              toClear.push({ row: r, col: cc });
            }
          }
          runType = type;
          runStart = c;
        }
      }
    }

    for (let c = 0; c < boardCols; c++) {
      let runType = null;
      let runStart = 0;
      for (let r = 0; r <= boardRows; r++) {
        const cell = r < boardRows ? getCell(r, c) : null;
        const type = cell ? cell.type : null;
        if (type === runType && type != null) {
          continue;
        } else {
          if (runType != null && r - runStart >= 3) {
            for (let rr = runStart; rr < r; rr++) {
              toClear.push({ row: rr, col: c });
            }
          }
          runType = type;
          runStart = r;
        }
      }
    }

    const key = p => `${p.row}:${p.col}`;
    const map = {};
    toClear.forEach(p => { map[key(p)] = p; });
    return Object.values(map);
  }

  function handleMatches(matches) {
    matches.forEach(p => {
      const tile = matchBoardEl.querySelector(
        `.tile[data-row="${p.row}"][data-col="${p.col}"]`
      );
      if (tile) tile.classList.add("tile-clearing");
    });

    score += 10 * matches.length;
    scoreCurrentEl.textContent = score.toString();

    setTimeout(() => {
      matches.forEach(p => {
        const cellEl = matchBoardEl.querySelector(
          `.cell[data-row="${p.row}"][data-col="${p.col}"]`
        );
        currentBoard[p.row][p.col] = null;
        if (cellEl) cellEl.innerHTML = "";
      });
      applyGravity();
      refillBoard();
    }, 260);
  }

  function applyGravity() {
    for (let c = 0; c < boardCols; c++) {
      for (let r = boardRows - 1; r >= 0; r
